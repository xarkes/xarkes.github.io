<!doctype html><html lang=en><head><title>Bitwarden code review</title><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><link href=/fonts.css rel=stylesheet><link href=/style.css rel=stylesheet><body><main><nav><ul><li><a href=/>/index</a><li><a href=/b/>/blog</a><li><a href=https://github.com/xarkes>/github</a><li><a href=https://x.com/xarkes_>/x</a></ul></nav><div><h1>Bitwarden code review</h1><p><strong>Published on 2024-06-30</strong><p>Since a few months I am using <a href=https://bitwarden.com/>Bitwarden</a> as my password manager. The main reason I started using it was that I wanted an easy way to keep my passwords synchronised, which local password managers like <a href=https://keepassxc.org/>KeePassXC</a> do not provide. You end up having to implement your own synchronization mechanism for instance storing the database file in a cloud synchronised folder like <a href=https://en.wikipedia.org/wiki/Google_Drive>Google Drive</a>, <a href=https://www.dropbox.com/>DropBox</a>, <a href=https://nextcloud.com/>NextCloud</a>, etc.<p>Another reason is that Bitwarden is open-source and can be self-hosted, and since I enjoy <del>losing time</del> configuring my own infrastructure and wondering when my hard drive will die and if I made enough backups, I decided to use it for the past months.<p>I never took a glance at the implementation of Bitwarden but as my personal laptop is still my 9 year-old Lenovo X250, things around me are sometimes a bit laggy. I like when things are fast (when it comes to computers obviously) and the UIs I use responsive (as in fast). My current annoyances when it comes to the official Bitwarden client are the following:<ul><li>It's not very fast ie. when starting the process I have to wait ~5 seconds before being prompted for my password (I solely blame the desktop client to be a <a href=https://www.chromium.org/chromium-projects/>Chromium</a> browser running a JavaScript app)<li>Navigation is not so easy with a keyboard only</ul><p>When searching for an alternative desktop client on the web I found that some people were asking for it but there is actually none available. As an exercise and because I was wondering about the required effort to write a similar App using no web technologies, I started to dig into the source code in order to make a prototype implementation.</p><span id=continue-reading></span><h2 id=diving-in-bitwarden-source-code>Diving in Bitwarden source code</h2><p>So, how hard can it be to review a JavaScript application when I spend most of my days reading C++? Surely it did not sound worse to me but I was very wrong. The review I am doing below is based on <a href=https://github.com/bitwarden/clients/tree/f0673dd16e1d5784c66b8fabae3121fb725ac028>f0673dd16e1d5784c66b8fabae3121fb725ac028</a> as of June 29th 2024. The code base contains the source code for the following:<ul><li>Web client<li>Desktop clients (Windows, MacOS, Linux)<li>Browser extension<li>CLI client</ul><p>The clients communicates with the server using the server <a href=https://en.wikipedia.org/wiki/REST>REST</a> API (using HTTP and JSON).<h3 id=login-mechanism>Login mechanism</h3><p>The most simple login method is the password authentication which is implemented in <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/auth/src/common/login-strategies/password-login.strategy.ts>libs/auth/src/common/login-strategies/password-login.strategy.ts</a><pre class=language-typescript data-lang=typescript style=color:#c0c5ce;background-color:#2b303b><code class=language-typescript data-lang=typescript><span style=color:#bf616a>override async </span><span style=color:#8fa1b3>logIn</span><span>(</span><span style=color:#bf616a>credentials</span><span>: </span><span style=color:#bf616a>PasswordLoginCredentials</span><span>) {
</span><span>    </span><span style=color:#b48ead>const </span><span>{ </span><span style=color:#bf616a>email</span><span>, </span><span style=color:#bf616a>masterPassword</span><span>, </span><span style=color:#bf616a>captchaToken</span><span>, </span><span style=color:#bf616a>twoFactor </span><span>} = </span><span style=color:#bf616a>credentials</span><span>;
</span><span>
</span><span>    </span><span style=color:#b48ead>const </span><span style=color:#bf616a>data </span><span>= new PasswordLoginStrategyData();
</span><span>    </span><span style=color:#bf616a>data</span><span>.</span><span style=color:#bf616a>masterKey </span><span>= </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>loginStrategyService</span><span>.</span><span style=color:#8fa1b3>makePreloginKey</span><span>(</span><span style=color:#bf616a>masterPassword</span><span>, </span><span style=color:#bf616a>email</span><span>);
</span><span>    </span><span style=color:#bf616a>data</span><span>.</span><span style=color:#bf616a>userEnteredEmail </span><span>= </span><span style=color:#bf616a>email</span><span>;
</span><span>
</span><span>    </span><span style=color:#65737e>// Hash the password early (before authentication) so we don't persist it in memory in plaintext
</span><span>    </span><span style=color:#bf616a>data</span><span>.</span><span style=color:#bf616a>localMasterKeyHash </span><span>= </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>cryptoService</span><span>.</span><span style=color:#8fa1b3>hashMasterKey</span><span>(
</span><span>      </span><span style=color:#bf616a>masterPassword</span><span>,
</span><span>      </span><span style=color:#bf616a>data</span><span>.</span><span style=color:#bf616a>masterKey</span><span>,
</span><span>      </span><span style=color:#bf616a>HashPurpose</span><span>.</span><span style=color:#bf616a>LocalAuthorization</span><span>,
</span><span>    );
</span><span>    </span><span style=color:#b48ead>const </span><span style=color:#bf616a>serverMasterKeyHash </span><span>= </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>cryptoService</span><span>.</span><span style=color:#8fa1b3>hashMasterKey</span><span>(
</span><span>      </span><span style=color:#bf616a>masterPassword</span><span>,
</span><span>      </span><span style=color:#bf616a>data</span><span>.</span><span style=color:#bf616a>masterKey</span><span>,
</span><span>    );
</span><span>
</span><span>    </span><span style=color:#bf616a>data</span><span>.</span><span style=color:#bf616a>tokenRequest </span><span>= new PasswordTokenRequest(
</span><span>      </span><span style=color:#bf616a>email</span><span>,
</span><span>      </span><span style=color:#bf616a>serverMasterKeyHash</span><span>,
</span><span>      </span><span style=color:#bf616a>captchaToken</span><span>,
</span><span>      </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#8fa1b3>buildTwoFactor</span><span>(</span><span style=color:#bf616a>twoFactor</span><span>, </span><span style=color:#bf616a>email</span><span>),
</span><span>      </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#8fa1b3>buildDeviceRequest</span><span>(),
</span><span>    );
</span><span>
</span><span>    </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>cache</span><span>.</span><span style=color:#8fa1b3>next</span><span>(</span><span style=color:#bf616a>data</span><span>);
</span><span>
</span><span>    </span><span style=color:#b48ead>const </span><span>[</span><span style=color:#bf616a>authResult</span><span>, </span><span style=color:#bf616a>identityResponse</span><span>] = </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#8fa1b3>startLogIn</span><span>();
</span><span>
</span><span>	</span><span style=color:#65737e>// [snip]
</span><span>
</span></code></pre><pre class=language-typescript data-lang=typescript style=color:#c0c5ce;background-color:#2b303b><code class=language-typescript data-lang=typescript><span>  </span><span style=color:#bf616a>protected async </span><span style=color:#8fa1b3>startLogIn</span><span>(): </span><span style=color:#ebcb8b>Promise</span><span><[</span><span style=color:#bf616a>AuthResult</span><span>, </span><span style=color:#bf616a>IdentityResponse</span><span>]> {
</span><span>    await this.twoFactorService.clearSelectedProvider();
</span><span>
</span><span>    const </span><span style=color:#bf616a>tokenRequest </span><span>= </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>cache</span><span>.value.</span><span style=color:#bf616a>tokenRequest</span><span>;
</span><span>    const </span><span style=color:#bf616a>response </span><span>= </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>apiService</span><span>.</span><span style=color:#8fa1b3>postIdentityToken</span><span>(</span><span style=color:#bf616a>tokenRequest</span><span>);
</span><span>
</span><span>    </span><span style=color:#8fa1b3>if </span><span>(</span><span style=color:#bf616a>response instanceof IdentityTwoFactorResponse</span><span>) {
</span><span>      </span><span style=color:#b48ead>return </span><span>[</span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#8fa1b3>processTwoFactorResponse</span><span>(</span><span style=color:#bf616a>response</span><span>), </span><span style=color:#bf616a>response</span><span>];
</span><span>    } else </span><span style=color:#8fa1b3>if </span><span>(</span><span style=color:#bf616a>response instanceof IdentityCaptchaResponse</span><span>) {
</span><span>      </span><span style=color:#b48ead>return </span><span>[</span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#8fa1b3>processCaptchaResponse</span><span>(</span><span style=color:#bf616a>response</span><span>), </span><span style=color:#bf616a>response</span><span>];
</span><span>    } else </span><span style=color:#8fa1b3>if </span><span>(</span><span style=color:#bf616a>response instanceof IdentityTokenResponse</span><span>) {
</span><span>      </span><span style=color:#b48ead>return </span><span>[</span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#8fa1b3>processTokenResponse</span><span>(</span><span style=color:#bf616a>response</span><span>), </span><span style=color:#bf616a>response</span><span>];
</span><span>    }
</span><span>
</span><span>    throw new </span><span style=color:#8fa1b3>Error</span><span>("</span><span style=color:#a3be8c>Invalid response object.</span><span>");
</span><span>  }
</span></code></pre><p>From the above code what I learned is we have the following:<ul><li><code>masterKey</code> derivated from password and email<li><code>localMasterKeyHash</code> derivated from password and <code>masterKey</code><li><code>serverMasterKeyHash</code> derivated from password and <code>masterKey</code><li><code>tokenRequest</code> is generated from email and <code>serverMasterKeyHash</code> and passed to <code>startLogIn</code> through <code>cache.next()</code> which makes it really not obvious<li><code>startLogIn</code> will use <code>tokenRequest</code> to log in to the server</ul><p>As a first analysis we can see that things are really unclear and some things seem odd. Let's adjust our understanding and let's find out how the <code>masterKey</code> is derivated finding <code>makePreloginKey</code>. Grep is a really good friend when it comes to navigating the code base, because there are so many levels of abstractions that it's not obvious where the code would be. Here we find one implementation in <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/auth/src/common/services/login-strategies/login-strategy.service.ts#L240>libs/auth/src/common/services/login-strategies/login-strategy.service.ts#L240</a><pre class=language-typescript data-lang=typescript style=color:#c0c5ce;background-color:#2b303b><code class=language-typescript data-lang=typescript><span style=color:#bf616a>async </span><span style=color:#8fa1b3>makePreloginKey</span><span>(</span><span style=color:#bf616a>masterPassword</span><span>: </span><span style=color:#bf616a>string</span><span>, </span><span style=color:#bf616a>email</span><span>: </span><span style=color:#bf616a>string</span><span>): </span><span style=color:#ebcb8b>Promise</span><span><</span><span style=color:#bf616a>MasterKey</span><span>> {
</span><span>    </span><span style=color:#bf616a>email </span><span>= </span><span style=color:#bf616a>email</span><span>.</span><span style=color:#8fa1b3>trim</span><span>().</span><span style=color:#96b5b4>toLowerCase</span><span>();
</span><span>    let kdfConfig: </span><span style=color:#bf616a>KdfConfig </span><span>= </span><span style=color:#d08770>null</span><span>;
</span><span>    </span><span style=color:#bf616a>try </span><span>{
</span><span>      const </span><span style=color:#bf616a>preloginResponse </span><span>= </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>apiService</span><span>.</span><span style=color:#8fa1b3>postPrelogin</span><span>(new PreloginRequest(</span><span style=color:#bf616a>email</span><span>));
</span><span>      </span><span style=color:#8fa1b3>if </span><span>(</span><span style=color:#bf616a>preloginResponse</span><span> != </span><span style=color:#bf616a>null</span><span>) {
</span><span>        </span><span style=color:#bf616a>kdfConfig </span><span>=
</span><span>          </span><span style=color:#bf616a>preloginResponse</span><span>.</span><span style=color:#bf616a>kdf </span><span>=== </span><span style=color:#bf616a>KdfType</span><span>.</span><span style=color:#bf616a>PBKDF2_SHA256
</span><span>            ? new PBKDF2KdfConfig(</span><span style=color:#bf616a>preloginResponse</span><span>.</span><span style=color:#bf616a>kdfIterations</span><span>)
</span><span>            : new Argon2KdfConfig(
</span><span>                </span><span style=color:#bf616a>preloginResponse</span><span>.</span><span style=color:#bf616a>kdfIterations</span><span>,
</span><span>                </span><span style=color:#bf616a>preloginResponse</span><span>.</span><span style=color:#bf616a>kdfMemory</span><span>,
</span><span>                </span><span style=color:#bf616a>preloginResponse</span><span>.</span><span style=color:#bf616a>kdfParallelism</span><span>,
</span><span>              );
</span><span>      }
</span><span>    } </span><span style=color:#8fa1b3>catch </span><span>(</span><span style=color:#bf616a>e</span><span>) {
</span><span>      </span><span style=color:#8fa1b3>if </span><span>(</span><span style=color:#bf616a>e</span><span> == </span><span style=color:#bf616a>null</span><span> || e.statusCode !== 404) {
</span><span>        </span><span style=color:#b48ead>throw </span><span style=color:#bf616a>e</span><span>;
</span><span>      }
</span><span>    }
</span><span>    </span><span style=color:#bf616a>return </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>cryptoService</span><span>.</span><span style=color:#8fa1b3>makeMasterKey</span><span>(</span><span style=color:#bf616a>masterPassword</span><span>, </span><span style=color:#bf616a>email</span><span>, </span><span style=color:#bf616a>kdfConfig</span><span>);
</span><span>  }
</span></code></pre><p>In fact this method will do another <code>POST</code> request to the server in order to retrieve more information:<ul><li>The <a href=https://en.wikipedia.org/wiki/Key_derivation_function>Key Derivation Function</a> (KDF)<li>The KDF iterations count</ul><p>Already I feel a bit puzzled as I was expecting <code>makePreloginKey</code> to… make a pre login key. Not another HTTP request. Eventually it will give me that key, but in terms of software readability, this is odd. Let's dig more and find the implementation of <code>makeMasterKey</code>: <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/crypto.service.ts#L257>libs/common/src/platform/services/crypto.service.ts#L257</a><pre class=language-typescript data-lang=typescript style=color:#c0c5ce;background-color:#2b303b><code class=language-typescript data-lang=typescript><span>  </span><span style=color:#65737e>/**
</span><span style=color:#65737e>   * Derive a master key from a password and email.
</span><span style=color:#65737e>   *
</span><span style=color:#65737e>   * </span><span style=color:#b48ead>@remarks
</span><span style=color:#65737e>   * Does not validate the kdf config to ensure it satisfies the minimum requirements for the given kdf type.
</span><span style=color:#65737e>   * TODO: Move to MasterPasswordService
</span><span style=color:#65737e>   */
</span><span>  </span><span style=color:#bf616a>async </span><span style=color:#8fa1b3>makeMasterKey</span><span>(</span><span style=color:#bf616a>password</span><span>: </span><span style=color:#bf616a>string</span><span>, </span><span style=color:#bf616a>email</span><span>: </span><span style=color:#bf616a>string</span><span>, </span><span style=color:#bf616a>KdfConfig</span><span>: </span><span style=color:#bf616a>KdfConfig</span><span>): </span><span style=color:#ebcb8b>Promise</span><span><</span><span style=color:#bf616a>MasterKey</span><span>> {
</span><span>    </span><span style=color:#8fa1b3>return </span><span>(</span><span style=color:#bf616a>await</span><span> this.keyGenerationService.deriveKeyFromPassword(
</span><span>      </span><span style=color:#bf616a>password</span><span>,
</span><span>      </span><span style=color:#bf616a>email</span><span>,
</span><span>      </span><span style=color:#bf616a>KdfConfig</span><span>,
</span><span>    )) as MasterKey;
</span><span>  }
</span></code></pre><p>Let's dig more: <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/key-generation.service.ts#L40>libs/common/src/platform/services/key-generation.service.ts#L40</a><pre class=language-typescript data-lang=typescript style=color:#c0c5ce;background-color:#2b303b><code class=language-typescript data-lang=typescript><span>  </span><span style=color:#bf616a>async </span><span style=color:#8fa1b3>deriveKeyFromPassword</span><span>(
</span><span>    </span><span style=color:#bf616a>password</span><span>: </span><span style=color:#bf616a>string </span><span>| </span><span style=color:#ebcb8b>Uint8Array</span><span>,
</span><span>    </span><span style=color:#bf616a>salt</span><span>: </span><span style=color:#bf616a>string </span><span>| </span><span style=color:#ebcb8b>Uint8Array</span><span>,
</span><span>    </span><span style=color:#bf616a>kdfConfig</span><span>: </span><span style=color:#bf616a>KdfConfig</span><span>,
</span><span>  ): </span><span style=color:#ebcb8b>Promise</span><span><</span><span style=color:#bf616a>SymmetricCryptoKey</span><span>> {
</span><span>    let key: </span><span style=color:#ebcb8b>Uint8Array </span><span>= </span><span style=color:#d08770>null</span><span>;
</span><span>    </span><span style=color:#8fa1b3>if </span><span>(</span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>kdfType </span><span>== </span><span style=color:#d08770>null </span><span>|| </span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>kdfType </span><span>=== </span><span style=color:#bf616a>KdfType</span><span>.</span><span style=color:#bf616a>PBKDF2_SHA256</span><span>) {
</span><span>      </span><span style=color:#8fa1b3>if </span><span>(kdfConfig.iterations == </span><span style=color:#bf616a>null</span><span>) {
</span><span>        </span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>iterations </span><span>= </span><span style=color:#bf616a>PBKDF2KdfConfig</span><span>.</span><span style=color:#bf616a>ITERATIONS</span><span>.defaultValue;
</span><span>      }
</span><span>
</span><span>      </span><span style=color:#bf616a>key </span><span>= </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>cryptoFunctionService</span><span>.</span><span style=color:#8fa1b3>pbkdf2</span><span>(</span><span style=color:#bf616a>password</span><span>, </span><span style=color:#bf616a>salt</span><span>, "</span><span style=color:#a3be8c>sha256</span><span>", </span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>iterations</span><span>);
</span><span>    } </span><span style=color:#bf616a>else </span><span style=color:#8fa1b3>if </span><span>(</span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>kdfType </span><span>== </span><span style=color:#bf616a>KdfType</span><span>.</span><span style=color:#bf616a>Argon2id</span><span>) {
</span><span>      </span><span style=color:#8fa1b3>if </span><span>(kdfConfig.iterations == </span><span style=color:#bf616a>null</span><span>) {
</span><span>        </span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>iterations </span><span>= </span><span style=color:#bf616a>Argon2KdfConfig</span><span>.</span><span style=color:#bf616a>ITERATIONS</span><span>.defaultValue;
</span><span>      }
</span><span>
</span><span>      </span><span style=color:#8fa1b3>if </span><span>(kdfConfig.memory == </span><span style=color:#bf616a>null</span><span>) {
</span><span>        </span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>memory </span><span>= </span><span style=color:#bf616a>Argon2KdfConfig</span><span>.</span><span style=color:#bf616a>MEMORY</span><span>.defaultValue;
</span><span>      }
</span><span>
</span><span>      </span><span style=color:#8fa1b3>if </span><span>(kdfConfig.parallelism == </span><span style=color:#bf616a>null</span><span>) {
</span><span>        </span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>parallelism </span><span>= </span><span style=color:#bf616a>Argon2KdfConfig</span><span>.</span><span style=color:#bf616a>PARALLELISM</span><span>.defaultValue;
</span><span>      }
</span><span>
</span><span>      const </span><span style=color:#bf616a>saltHash </span><span>= </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>cryptoFunctionService</span><span>.</span><span style=color:#8fa1b3>hash</span><span>(</span><span style=color:#bf616a>salt</span><span>, "</span><span style=color:#a3be8c>sha256</span><span>");
</span><span>      </span><span style=color:#bf616a>key </span><span>= </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>cryptoFunctionService</span><span>.</span><span style=color:#8fa1b3>argon2</span><span>(
</span><span>        </span><span style=color:#bf616a>password</span><span>,
</span><span>        </span><span style=color:#bf616a>saltHash</span><span>,
</span><span>        </span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>iterations</span><span>,
</span><span>        </span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>memory </span><span>* </span><span style=color:#d08770>1024</span><span>, </span><span style=color:#65737e>// convert to KiB from MiB
</span><span>        </span><span style=color:#bf616a>kdfConfig</span><span>.</span><span style=color:#bf616a>parallelism</span><span>,
</span><span>      );
</span><span>    } </span><span style=color:#bf616a>else </span><span>{
</span><span>      throw new </span><span style=color:#8fa1b3>Error</span><span>("</span><span style=color:#a3be8c>Unknown Kdf.</span><span>");
</span><span>    }
</span><span>    </span><span style=color:#bf616a>return </span><span>new SymmetricCryptoKey(</span><span style=color:#bf616a>key</span><span>);
</span><span>  }
</span></code></pre><p>Finally, we can be confident the <code>masterKey</code> will be derivated from the master password using the email and either Argon2d or PBKDF2 as a KDF. Let's jump directly to <code>startLogIn</code> and see what data is sent to the server.<ol><li>Calling <code>postIdentityToken</code> with <code>tokenRequest </code><a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/services/api.service.ts#L190>libs/common/src/services/api.service.ts#L190</a><li>Data is extracted using <code>toIdentityToken</code> from <code>PasswordTokenRequest</code> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/models/request/identity-token/password-token.request.ts#L20>libs/common/src/auth/models/request/identity-token/password-token.request.ts#L20</a><li>.. which sets the <code>password</code> field to <code>masterPasswordHash</code> which is in fact <code>serverPasswordHash</code> computed earlier.</ol><p>Recap:<ol><li>User password is hashed with a KDF<li><code>serverPasswordHash</code> is computed from previous hash<li>Hash is sent to server to validate authentication</ol><p>The mechanism is very simple and yet not that easy to read from the code source. Also, we still have no idea what <code>localPasswordHash</code> is used for.<h3 id=database-decryption>Database decryption</h3><p>Now that we know how the master password is sent to the server, let's see how passwords are decrypted. I will not quote all the code as previously as it is too heavy to read but rather just point out the interesting parts.<ol><li>The server answers with an <code>access_token</code> valid for a certain amount of time that allows us to authenticate to read or write entries, and a <code>key</code> parameter, among many other. They are stored using the <code>IdentityTokenResponse</code> structure <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/models/response/identity-token.response.ts#L28>libs/common/src/auth/models/response/identity-token.response.ts#L28</a><li>The <code>key</code> is decrypted using a stretched <code>masterKey</code> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/services/master-password/master-password.service.ts#L181>libs/common/src/auth/services/master-password/master-password.service.ts#L181</a><li>The client initiates a <code>GET</code> request on <code>/api/sync</code> to pull the whole database. <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/sync/default-sync.service.ts#L119>libs/common/src/platform/sync/default-sync.service.ts#L119</a><li>The data is read and synchronized locally into <code>cipherServices</code> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/sync/default-sync.service.ts#L303>libs/common/src/platform/sync/default-sync.service.ts#L303</a> using yet another data structure named <code>CipherData</code><li>Then I <em>assume</em> the view will load the cipher and decrypt it <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/angular/src/vault/components/view.component.ts#L131>libs/angular/src/vault/components/view.component.ts#L131</a><li>The decryption key is retrieved with <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/services/cipher.service.ts#L1159>again</a> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/crypto.service.ts#L131>more</a> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/services/master-password/master-password.service.ts#L64>unclear</a> code (the <code>StateProvider</code> <code>MASTER_KEY</code> field was set <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/auth/src/common/login-strategies/password-login.strategy.ts#L173>earlier during login</a> and it corresponds to what we called <code>masterKey</code> - remember how <code>this.cache.value</code> was set).<li>Then <code>decrypt</code> is called <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/models/domain/cipher.ts#L126>libs/common/src/vault/models/domain/cipher.ts#L126</a><li>Another more specific <code>decrypt</code> is called <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/models/domain/login.ts#L53>libs/common/src/vault/models/domain/login.ts#L53</a><li>Which calls a more specific <code>decryptObj</code> function <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/domain-base.ts#L49>libs/common/src/platform/models/domain/domain-base.ts#L49</a> which is hard to read due to a lot of messy JavaScript syntax<li>It should end up calling <code>EncString.decrypt</code> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/enc-string.ts#L154>libs/common/src/platform/models/domain/enc-string.ts#L154</a> (was it parsed from JSON here <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/models/domain/cipher.ts#L265>libs/common/src/vault/models/domain/cipher.ts#L265</a> ?)<li>Eventually everything relies on <code>decryptToUtf8</code> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/cryptography/encrypt.service.implementation.ts#L66>libs/common/src/platform/services/cryptography/encrypt.service.implementation.ts#L66</a><li>It will do some AES-CBC and decrypt the content</ol><p>Note that the answer from step 2 is in the following form:<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span>{
</span><span>  "</span><span style=color:#a3be8c>Ciphers</span><span>": [
</span><span>    {
</span><span>      "</span><span style=color:#a3be8c>Attachments</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Card</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>CollectionIds</span><span>": [],
</span><span>      "</span><span style=color:#a3be8c>CreationDate</span><span>": "</span><span style=color:#a3be8c>2024-06-09T16:35:15.038251Z</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Data</span><span>": {
</span><span>        "</span><span style=color:#a3be8c>Fields</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>        "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>2.49gWnoaK1nI5Pn/pSIOYrg==|5YpydD3KvqmmAej7fP/nkw==|+y1sS1Pi28xOPQT14k4UrYtc9TSJfgsf+nUjH3n/AAs=</span><span>",
</span><span>        "</span><span style=color:#a3be8c>Notes</span><span>": "",
</span><span>        "</span><span style=color:#a3be8c>Password</span><span>": "</span><span style=color:#a3be8c>2.49gWnoaK1nI5Pn/pSIOYrg==|YpifIojSBpof3EbQ0GyNBA==|0WBUgT11Hwi6Hb8H4bks+ICsMFBH88QMIGyemLBFYog=</span><span>",
</span><span>        "</span><span style=color:#a3be8c>PasswordHistory</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>        "</span><span style=color:#a3be8c>Uri</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>        "</span><span style=color:#a3be8c>Username</span><span>": "</span><span style=color:#a3be8c>2.49gWnoaK1nI5Pn/pSIOYrg==|ZUZugs7e8BsQ1Fe/qNAbfDO4fZUnsoq5Z55dcFDr37I=|dGIniQkSI7Xistm0KoJW8s6OfmGBS0OyfuBQCc3O52c=</span><span>"
</span><span>      },
</span><span>      "</span><span style=color:#a3be8c>DeletedDate</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Edit</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Favorite</span><span>": </span><span style=color:#d08770>false</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Fields</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>FolderId</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Id</span><span>": "</span><span style=color:#a3be8c>c8d320e9-c4c3-446c-8ede-f322edf0a980</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Identity</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Key</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Login</span><span>": {
</span><span>        "</span><span style=color:#a3be8c>Password</span><span>": "</span><span style=color:#a3be8c>2.49gWnoaK1nI5Pn/pSIOYrg==|YpifIojSBpof3EbQ0GyNBA==|0WBUgT11Hwi6Hb8H4bks+ICsMFBH88QMIGyemLBFYog=</span><span>",
</span><span>        "</span><span style=color:#a3be8c>Uri</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>        "</span><span style=color:#a3be8c>Username</span><span>": "</span><span style=color:#a3be8c>2.49gWnoaK1nI5Pn/pSIOYrg==|ZUZugs7e8BsQ1Fe/qNAbfDO4fZUnsoq5Z55dcFDr37I=|dGIniQkSI7Xistm0KoJW8s6OfmGBS0OyfuBQCc3O52c=</span><span>"
</span><span>      },
</span><span>      "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>2.49gWnoaK1nI5Pn/pSIOYrg==|5YpydD3KvqmmAej7fP/nkw==|+y1sS1Pi28xOPQT14k4UrYtc9TSJfgsf+nUjH3n/AAs=</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Notes</span><span>": "",
</span><span>      "</span><span style=color:#a3be8c>Object</span><span>": "</span><span style=color:#a3be8c>cipherDetails</span><span>",
</span><span>      "</span><span style=color:#a3be8c>OrganizationId</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>OrganizationUseTotp</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>PasswordHistory</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Reprompt</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>RevisionDate</span><span>": "</span><span style=color:#a3be8c>2024-06-17T20:30:24.341656Z</span><span>",
</span><span>      "</span><span style=color:#a3be8c>SecureNote</span><span>": </span><span style=color:#d08770>null</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Type</span><span>": </span><span style=color:#d08770>1</span><span>,
</span><span>      "</span><span style=color:#a3be8c>ViewPassword</span><span>": </span><span style=color:#d08770>true
</span><span>    },
</span><span>    { 
</span><span>      </span><span style=color:#65737e>// ... more ciphers
</span><span>    }
</span><span>  ]
</span><span>}
</span></code></pre><p>Bitwarden has 4 types of entries: identities, cards, logins and notes. The above entry is a login entry, and the server sends duplicate information for the name, password and username.<p>But oops, I forgot to mention the <code>EncString</code> instantiation has to parse this format: <code>2.49gWnoaK1nI5Pn/pSIOYrg==|5YpydD3KvqmmAej7fP/nkw==|+y1sS1Pi28xOPQT14k4UrYtc9TSJfgsf+nUjH3n/AAs=</code>.<p>Indeed it is defined as <code>ALGO . IV_b64 | DATA_b64 | MAC_b64</code> (well, almost: <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/enc-string.ts#L111>libs/common/src/platform/models/domain/enc-string.ts#L111</a> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/enc-string.ts#L72>libs/common/src/platform/models/domain/enc-string.ts#L72</a>)<p>That's it, I am a bit tired of trying to find my way around the code.<h2 id=cryptanalysis>Cryptanalysis</h2><p>I am no cryptographer but as far as I know cryptography implementation mistakes lie in the details. So, let's recap with not too much details.<ol><li>The client makes a request to the server (hopefully using https)<li>The server sends back a <code>KdfIteration</code> and <code>Kdf</code> field such that the client knows either to use PBKDF2 or Argon2id, and how many times it should iterate. The default configuration for my vault is <code>0</code> aka PBKDF2 and <code>600000</code> iterations, so we will keep that for the analysis.<li>The client prompts the user password and email, and derives them using the information from the previous step, computing <code>masterKey = PBKDF2(SHA256, password, email, 600000)</code><li>Regardless of the previous <code>Kdf</code> , <code>serverMasterKeyHash</code> is computed as <code>PBKDF2(SHA256, masterKey, password, 1)</code><li><code>serverMasterKeyHash</code> is sent to the server to authenticate<li>If authentication is successful, the server sends back an encrypted <code>Key</code> which is decrypted to get the decryption key <code>CipherKey</code>. First a stretched key and mac key are computed: <code>StretchedKey = HKDFExpandSHA256(masterKey, "enc")</code> and <code>MacKey = HKDFExpandSHA256(masterKey, "mac")</code>. Then the received key is decrypted: <code>CipherKey = AES256_CBC_Decrypt(StretchedKey, Key_iv, Key_data)</code><li>Ciphers (ie. names, notes, passwords, … - any string except dates) come with their encryption algorithm, IV, data and MAC data. The current default is AES256_CBC with HMAC_SHA256 but the codebase implements backwards compatibility with other schemes.<li>Ciphers are first checked with their MAC data as <code>cipher_mac == HMAC_SHA256(cipher_iv || cipher_data, MacKey)</code><li>If successful, also decrypted as <code>clear = AES256_CBC_Decrypt(CipherKey, cipher_iv, cipher_data)</code></ol><p>So the master password is derived 600,000 times which follows <a href=https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#pbkdf2>Owasp Password Storage cheatsheet</a> and Bitwarden uses standard encryption algorithms. We could argue that the usage of AES CBC with HMAC is a bit clumsy as one would rather use a more modern alternative like AES <a href=https://en.wikipedia.org/wiki/Galois/Counter_Mode>GCM</a>.<h2 id=conclusion>Conclusion</h2><p>I consider the code of Bitwarden client to be of poor manufacture. I found it very hard to read, with too many layers of abstractions. To me, a software designed to securely store your most private things should be easy to read and easy to contribute to. In my opinion, finding where things where located in the code base was quite hard.<p>Here, the technical choice was to have an all-in-one application for the web and your desktop, which explains the usage of JavaScript (actually TypeScript, kudos!). Unfortunately I feel like although JavaScript is a super high-level language, the code was designed in a too hard to read fashion.<p>I started writing my own desktop client for the reasons I mentioned at the beginning of this article, using the <a href=https://www.qt.io/>Qt</a> framework with C++. While it's not complete, you can check its implementation <a href=https://github.com/xarkes/bwd>here</a>. Is it easier to read? I hope so! Is it better? Not at all!</div></main><footer>2024 - Antide Petit aka <a href=https://xarkes.com>xarkes</a> - <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA</a> - Made with ❤️</footer>