<!DOCTYPE html><html lang=en><head><title>Bitwarden code review</title><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=description content="An analysis of Bitwarden's desktop client source code in an attempt to understand its encryption mechanisms and internals. Bitwarden desktop client is shared with the web application and written in TypeScript. Although it is an high level language, this code review shows that things are not very clear to understand and the exercise was a bit tedious."><meta name=author content="Antide Petit"><link rel=stylesheet type=text/css href=/static/css/style.css><link rel=stylesheet type=text/css href=/static/css/native.css></head><body><main><nav><ul><li><a href=/ >Index</a></li><li><a href=/b>Blog</a></li><li><a href=https://github.com/xarkes>Git</a></li><li><a href=https://twitter.com/xarkes_>Twitter</a></li></ul></nav><article><h1><a href=/b/bitwarden-code-review.html>Bitwarden code review</a></h1><p class=meta>Published on 30 Jun 2024</p><p>Since a few months I am using <a href=https://bitwarden.com/ >Bitwarden</a> as my password manager. The main reason I started using it was that I wanted an easy way to keep my passwords synchronised, which local password managers like <a href=https://keepassxc.org/ >KeePassXC</a> do not provide. You end up having to implement your own synchronization mechanism for instance storing the database file in a cloud synchronised folder like <a href=https://en.wikipedia.org/wiki/Google_Drive>Google Drive</a>, <a href=https://www.dropbox.com/ >DropBox</a>, <a href=https://nextcloud.com/ >NextCloud</a>, etc. </p><p>Another reason is that Bitwarden is open-source and can be self-hosted, and since I enjoy ~~losing time~~ configuring my own infrastructure and wondering when my hard drive will die and if I made enough backups, I decided to use it for the past months. </p><p>I never took a glance at the implementation of Bitwarden but as my personal laptop is still my 9 year-old Lenovo X250, things around me are sometimes a bit laggy. I like when things are fast (when it comes to computers obviously) and the UIs I use responsive (as in fast). My current annoyances when it comes to the official Bitwarden client are the following: </p><ul><li>It's not very fast ie. when starting the process I have to wait ~5 seconds before being prompted for my password (I solely blame the desktop client to be a <a href=https://www.chromium.org/chromium-projects/ >Chromium</a> browser running a JavaScript app) </li><li>Navigation is not so easy with a keyboard only </li></ul><p>When searching for an alternative desktop client on the web I found that some people were asking for it but there is actually none available. As an exercise and because I was wondering about the required effort to write a similar App using no web technologies, I started to dig into the source code in order to make a prototype implementation. </p><h2>Diving in Bitwarden source code</h2><p>So, how hard can it be to review a JavaScript application when I spend most of my days reading C++? Surely it did not sound worse to me but I was very wrong. The review I am doing below is based on <a href=https://github.com/bitwarden/clients/tree/f0673dd16e1d5784c66b8fabae3121fb725ac028>f0673dd16e1d5784c66b8fabae3121fb725ac028</a> as of June 29th 2024. The code base contains the source code for the following: </p><ul><li>Web client</li><li>Desktop clients (Windows, MacOS, Linux)</li><li>Browser extension</li><li>CLI client</li></ul><p>The clients communicates with the server using the server <a href=https://en.wikipedia.org/wiki/REST>REST</a> API (using HTTP and JSON). </p><h3>Login mechanism</h3><p>The most simple login method is the password authentication which is implemented in <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/auth/src/common/login-strategies/password-login.strategy.ts>libs/auth/src/common/login-strategies/password-login.strategy.ts</a> </p><div class=codehilite><pre><span></span><code><span class=kd>override</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>logIn</span><span class=p>(</span><span class=nx>credentials</span><span class=o>:</span><span class=w> </span><span class=kt>PasswordLoginCredentials</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>email</span><span class=p>,</span><span class=w> </span><span class=nx>masterPassword</span><span class=p>,</span><span class=w> </span><span class=nx>captchaToken</span><span class=p>,</span><span class=w> </span><span class=nx>twoFactor</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>credentials</span><span class=p>;</span>

<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PasswordLoginStrategyData</span><span class=p>();</span>
<span class=w>    </span><span class=nx>data</span><span class=p>.</span><span class=nx>masterKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>loginStrategyService</span><span class=p>.</span><span class=nx>makePreloginKey</span><span class=p>(</span><span class=nx>masterPassword</span><span class=p>,</span><span class=w> </span><span class=nx>email</span><span class=p>);</span>
<span class=w>    </span><span class=nx>data</span><span class=p>.</span><span class=nx>userEnteredEmail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>email</span><span class=p>;</span>

<span class=w>    </span><span class=c1>// Hash the password early (before authentication) so we don&#39;t persist it in memory in plaintext</span>
<span class=w>    </span><span class=nx>data</span><span class=p>.</span><span class=nx>localMasterKeyHash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>cryptoService</span><span class=p>.</span><span class=nx>hashMasterKey</span><span class=p>(</span>
<span class=w>      </span><span class=nx>masterPassword</span><span class=p>,</span>
<span class=w>      </span><span class=nx>data</span><span class=p>.</span><span class=nx>masterKey</span><span class=p>,</span>
<span class=w>      </span><span class=nx>HashPurpose</span><span class=p>.</span><span class=nx>LocalAuthorization</span><span class=p>,</span>
<span class=w>    </span><span class=p>);</span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>serverMasterKeyHash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>cryptoService</span><span class=p>.</span><span class=nx>hashMasterKey</span><span class=p>(</span>
<span class=w>      </span><span class=nx>masterPassword</span><span class=p>,</span>
<span class=w>      </span><span class=nx>data</span><span class=p>.</span><span class=nx>masterKey</span><span class=p>,</span>
<span class=w>    </span><span class=p>);</span>

<span class=w>    </span><span class=nx>data</span><span class=p>.</span><span class=nx>tokenRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PasswordTokenRequest</span><span class=p>(</span>
<span class=w>      </span><span class=nx>email</span><span class=p>,</span>
<span class=w>      </span><span class=nx>serverMasterKeyHash</span><span class=p>,</span>
<span class=w>      </span><span class=nx>captchaToken</span><span class=p>,</span>
<span class=w>      </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>buildTwoFactor</span><span class=p>(</span><span class=nx>twoFactor</span><span class=p>,</span><span class=w> </span><span class=nx>email</span><span class=p>),</span>
<span class=w>      </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>buildDeviceRequest</span><span class=p>(),</span>
<span class=w>    </span><span class=p>);</span>

<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>next</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>

<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>authResult</span><span class=p>,</span><span class=w> </span><span class=nx>identityResponse</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>startLogIn</span><span class=p>();</span>

<span class=w>    </span><span class=c1>// [snip]</span>
</code></pre></div><div class=codehilite><pre><span></span><code><span class=w>  </span><span class=k>protected</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>startLogIn</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=p>[</span><span class=nx>AuthResult</span><span class=p>,</span><span class=w> </span><span class=nx>IdentityResponse</span><span class=p>]</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>twoFactorService</span><span class=p>.</span><span class=nx>clearSelectedProvider</span><span class=p>();</span>

<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>tokenRequest</span><span class=p>;</span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>apiService</span><span class=p>.</span><span class=nx>postIdentityToken</span><span class=p>(</span><span class=nx>tokenRequest</span><span class=p>);</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>response</span><span class=w> </span><span class=ow>instanceof</span><span class=w> </span><span class=nx>IdentityTwoFactorResponse</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=p>[</span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>processTwoFactorResponse</span><span class=p>(</span><span class=nx>response</span><span class=p>),</span><span class=w> </span><span class=nx>response</span><span class=p>];</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>response</span><span class=w> </span><span class=ow>instanceof</span><span class=w> </span><span class=nx>IdentityCaptchaResponse</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=p>[</span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>processCaptchaResponse</span><span class=p>(</span><span class=nx>response</span><span class=p>),</span><span class=w> </span><span class=nx>response</span><span class=p>];</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>response</span><span class=w> </span><span class=ow>instanceof</span><span class=w> </span><span class=nx>IdentityTokenResponse</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=p>[</span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>processTokenResponse</span><span class=p>(</span><span class=nx>response</span><span class=p>),</span><span class=w> </span><span class=nx>response</span><span class=p>];</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s2>&quot;Invalid response object.&quot;</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div><p>From the above code what I learned is we have the following: </p><ul><li><code>masterKey</code> derivated from password and email </li><li><code>localMasterKeyHash</code> derivated from password and <code>masterKey</code> </li><li><code>serverMasterKeyHash</code> derivated from password and <code>masterKey</code> </li><li><code>tokenRequest</code> is generated from email and <code>serverMasterKeyHash</code> and passed to <code>startLogIn</code> through <code>cache.next()</code> which makes it really not obvious </li><li><code>startLogIn</code> will use <code>tokenRequest</code> to log in to the server </li></ul><p>As a first analysis we can see that things are really unclear and some things seem odd. Let's adjust our understanding and let's find out how the <code>masterKey</code> is derivated finding <code>makePreloginKey</code>. Grep is a really good friend when it comes to navigating the code base, because there are so many levels of abstractions that it's not obvious where the code would be. Here we find one implementation in <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/auth/src/common/services/login-strategies/login-strategy.service.ts#L240>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/auth/src/common/services/login-strategies/login-strategy.service.ts#L240</a> </p><div class=codehilite><pre><span></span><code><span class=k>async</span><span class=w> </span><span class=nx>makePreloginKey</span><span class=p>(</span><span class=nx>masterPassword</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>MasterKey</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nx>email</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>email</span><span class=p>.</span><span class=nx>trim</span><span class=p>().</span><span class=nx>toLowerCase</span><span class=p>();</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>kdfConfig</span><span class=o>:</span><span class=w> </span><span class=kt>KdfConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
<span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>preloginResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>apiService</span><span class=p>.</span><span class=nx>postPrelogin</span><span class=p>(</span><span class=ow>new</span><span class=w> </span><span class=nx>PreloginRequest</span><span class=p>(</span><span class=nx>email</span><span class=p>));</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>preloginResponse</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>kdfConfig</span><span class=w> </span><span class=o>=</span>
<span class=w>          </span><span class=nx>preloginResponse</span><span class=p>.</span><span class=nx>kdf</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>KdfType</span><span class=p>.</span><span class=nx>PBKDF2_SHA256</span>
<span class=w>            </span><span class=o>?</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PBKDF2KdfConfig</span><span class=p>(</span><span class=nx>preloginResponse</span><span class=p>.</span><span class=nx>kdfIterations</span><span class=p>)</span>
<span class=w>            </span><span class=o>:</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Argon2KdfConfig</span><span class=p>(</span>
<span class=w>                </span><span class=nx>preloginResponse</span><span class=p>.</span><span class=nx>kdfIterations</span><span class=p>,</span>
<span class=w>                </span><span class=nx>preloginResponse</span><span class=p>.</span><span class=nx>kdfMemory</span><span class=p>,</span>
<span class=w>                </span><span class=nx>preloginResponse</span><span class=p>.</span><span class=nx>kdfParallelism</span><span class=p>,</span>
<span class=w>              </span><span class=p>);</span>
<span class=w>      </span><span class=p>}</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>e</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>e</span><span class=p>.</span><span class=nx>statusCode</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=mf>404</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=nx>e</span><span class=p>;</span>
<span class=w>      </span><span class=p>}</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>cryptoService</span><span class=p>.</span><span class=nx>makeMasterKey</span><span class=p>(</span><span class=nx>masterPassword</span><span class=p>,</span><span class=w> </span><span class=nx>email</span><span class=p>,</span><span class=w> </span><span class=nx>kdfConfig</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div><p>In fact this method will do another <code>POST</code> request to the server in order to retrieve more information: </p><ul><li>The <a href=https://en.wikipedia.org/wiki/Key_derivation_function>Key Derivation Function</a> (KDF) </li><li>The KDF iterations count </li></ul><p>Already I feel a bit puzzled as I was expecting <code>makePreloginKey</code> to… make a pre login key. Not another HTTP request. Eventually it will give me that key, but in terms of software readability, this is odd. Let's dig more and find the implementation of <code>makeMasterKey</code> : <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/crypto.service.ts#L257>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/crypto.service.ts#L257</a> </p><div class=codehilite><pre><span></span><code><span class=w>  </span><span class=cm>/**</span>
<span class=cm>   * Derive a master key from a password and email.</span>
<span class=cm>   *</span>
<span class=cm>   * @remarks</span>
<span class=cm>   * Does not validate the kdf config to ensure it satisfies the minimum requirements for the given kdf type.</span>
<span class=cm>   * TODO: Move to MasterPasswordService</span>
<span class=cm>   */</span>
<span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>makeMasterKey</span><span class=p>(</span><span class=nx>password</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>KdfConfig</span><span class=o>:</span><span class=w> </span><span class=kt>KdfConfig</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>MasterKey</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>keyGenerationService</span><span class=p>.</span><span class=nx>deriveKeyFromPassword</span><span class=p>(</span>
<span class=w>      </span><span class=nx>password</span><span class=p>,</span>
<span class=w>      </span><span class=nx>email</span><span class=p>,</span>
<span class=w>      </span><span class=nx>KdfConfig</span><span class=p>,</span>
<span class=w>    </span><span class=p>))</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>MasterKey</span><span class=p>;</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div><p>Let's dig more: <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/key-generation.service.ts#L40>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/key-generation.service.ts#L40</a> </p><div class=codehilite><pre><span></span><code><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>deriveKeyFromPassword</span><span class=p>(</span>
<span class=w>    </span><span class=nx>password</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nb>Uint8Array</span><span class=p>,</span>
<span class=w>    </span><span class=nx>salt</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nb>Uint8Array</span><span class=p>,</span>
<span class=w>    </span><span class=nx>kdfConfig</span><span class=o>:</span><span class=w> </span><span class=kt>KdfConfig</span><span class=p>,</span>
<span class=w>  </span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>SymmetricCryptoKey</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>key</span><span class=o>:</span><span class=w> </span><span class=kt>Uint8Array</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>kdfType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>kdfType</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>KdfType</span><span class=p>.</span><span class=nx>PBKDF2_SHA256</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>iterations</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>iterations</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>PBKDF2KdfConfig</span><span class=p>.</span><span class=nx>ITERATIONS</span><span class=p>.</span><span class=nx>defaultValue</span><span class=p>;</span>
<span class=w>      </span><span class=p>}</span>

<span class=w>      </span><span class=nx>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>cryptoFunctionService</span><span class=p>.</span><span class=nx>pbkdf2</span><span class=p>(</span><span class=nx>password</span><span class=p>,</span><span class=w> </span><span class=nx>salt</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;sha256&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>iterations</span><span class=p>);</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>kdfType</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>KdfType</span><span class=p>.</span><span class=nx>Argon2id</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>iterations</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>iterations</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Argon2KdfConfig</span><span class=p>.</span><span class=nx>ITERATIONS</span><span class=p>.</span><span class=nx>defaultValue</span><span class=p>;</span>
<span class=w>      </span><span class=p>}</span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>memory</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>memory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Argon2KdfConfig</span><span class=p>.</span><span class=nx>MEMORY</span><span class=p>.</span><span class=nx>defaultValue</span><span class=p>;</span>
<span class=w>      </span><span class=p>}</span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>parallelism</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>parallelism</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Argon2KdfConfig</span><span class=p>.</span><span class=nx>PARALLELISM</span><span class=p>.</span><span class=nx>defaultValue</span><span class=p>;</span>
<span class=w>      </span><span class=p>}</span>

<span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>saltHash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>cryptoFunctionService</span><span class=p>.</span><span class=nx>hash</span><span class=p>(</span><span class=nx>salt</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;sha256&quot;</span><span class=p>);</span>
<span class=w>      </span><span class=nx>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>cryptoFunctionService</span><span class=p>.</span><span class=nx>argon2</span><span class=p>(</span>
<span class=w>        </span><span class=nx>password</span><span class=p>,</span>
<span class=w>        </span><span class=nx>saltHash</span><span class=p>,</span>
<span class=w>        </span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>iterations</span><span class=p>,</span>
<span class=w>        </span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>memory</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1024</span><span class=p>,</span><span class=w> </span><span class=c1>// convert to KiB from MiB</span>
<span class=w>        </span><span class=nx>kdfConfig</span><span class=p>.</span><span class=nx>parallelism</span><span class=p>,</span>
<span class=w>      </span><span class=p>);</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s2>&quot;Unknown Kdf.&quot;</span><span class=p>);</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>SymmetricCryptoKey</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div><p>Finally, we can be confident the <code>masterKey</code> will be derivated from the master password using the email and either Argon2d or PBKDF2 as a KDF. Let's jump directly to <code>startLogIn</code> and see what data is sent to the server. 1. Calling <code>postIdentityToken</code> with <code>tokenRequest</code><a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/services/api.service.ts#L190>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/services/api.service.ts#L190</a><br> 2. Data is extracted using <code>toIdentityToken</code> from <code>PasswordTokenRequest</code> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/models/request/identity-token/password-token.request.ts#L20>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/models/request/identity-token/password-token.request.ts#L20</a><br> 3. .. which sets the <code>password</code> field to <code>masterPasswordHash</code> which is in fact <code>serverPasswordHash</code> computed earlier. </p><p>Recap: </p><ol><li>User password is hashed with a KDF </li><li><code>serverPasswordHash</code> is computed from previous hash </li><li>Hash is sent to server to validate authentication </li></ol><p>The mechanism is very simple and yet not that easy to read from the code source. Also, we still have no idea what <code>localPasswordHash</code> is used for. </p><h3>Database decryption</h3><p>Now that we know how the master password is sent to the server, let's see how passwords are decrypted. I will not quote all the code as previously as it is too heavy to read but rather just point out the interesting parts. </p><ol><li>The server answers with an <code>access_token</code> valid for a certain amount of time that allows us to authenticate to read or write entries, and a <code>key</code> parameter, among many other. They are stored using the <code>IdentityTokenResponse</code> structure <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/models/response/identity-token.response.ts#L28>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/models/response/identity-token.response.ts#L28</a> </li><li>The <code>key</code> is decrypted using a stretched <code>masterKey</code> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/services/master-password/master-password.service.ts#L181>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/services/master-password/master-password.service.ts#L181</a> </li><li>The client initiates a <code>GET</code> request on <code>/api/sync</code> to pull the whole database. <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/sync/default-sync.service.ts#L119>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/sync/default-sync.service.ts#L119</a> </li><li>The data is read and synchronized locally into <code>cipherServices</code> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/sync/default-sync.service.ts#L303>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/sync/default-sync.service.ts#L303</a> using yet another data structure named <code>CipherData</code> </li><li>Then I <em>assume</em> the view will load the cipher and decrypt it <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/angular/src/vault/components/view.component.ts#L131>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/angular/src/vault/components/view.component.ts#L131</a> </li><li>The decryption key is retrieved with <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/services/cipher.service.ts#L1159>again</a> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/crypto.service.ts#L131>more</a> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/auth/services/master-password/master-password.service.ts#L64>unclear</a> code (the <code>StateProvider</code> <code>MASTER_KEY</code> field was set <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/auth/src/common/login-strategies/password-login.strategy.ts#L173>earlier during login</a> and it corresponds to what we called <code>masterKey</code> - remember how <code>this.cache.value</code> was set). </li><li>Then decrypt is called <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/models/domain/cipher.ts#L126>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/models/domain/cipher.ts#L126</a> </li><li>Another more specific decrypt is called <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/models/domain/login.ts#L53>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/models/domain/login.ts#L53</a> </li><li>Which calls a more specific decryptObj function <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/domain-base.ts#L49>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/domain-base.ts#L49</a> which is hard to read due to a lot of messy JavaScript syntax </li><li>It should end up calling EncString.decrypt <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/enc-string.ts#L154>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/enc-string.ts#L154</a> (was it parsed from JSON here <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/models/domain/cipher.ts#L265>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/vault/models/domain/cipher.ts#L265</a> ?) </li><li>Eventually everything relies on decryptToUtf8 <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/cryptography/encrypt.service.implementation.ts#L66>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/services/cryptography/encrypt.service.implementation.ts#L66</a> </li><li>It will do some AES-CBC and decrypt the content </li></ol><p>Note that the answer from step 2 is in the following form:</p><div class=codehilite><pre><span></span><code><span class=p>{</span>
<span class=w>  </span><span class=nt>&quot;Ciphers&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<span class=w>    </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;Attachments&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Card&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;CollectionIds&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[],</span>
<span class=w>      </span><span class=nt>&quot;CreationDate&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2024-06-09T16:35:15.038251Z&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nt>&quot;Fields&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2.49gWnoaK1nI5Pn/pSIOYrg==|5YpydD3KvqmmAej7fP/nkw==|+y1sS1Pi28xOPQT14k4UrYtc9TSJfgsf+nUjH3n/AAs=&quot;</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Notes&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Password&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2.49gWnoaK1nI5Pn/pSIOYrg==|YpifIojSBpof3EbQ0GyNBA==|0WBUgT11Hwi6Hb8H4bks+ICsMFBH88QMIGyemLBFYog=&quot;</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;PasswordHistory&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Uri&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Username&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2.49gWnoaK1nI5Pn/pSIOYrg==|ZUZugs7e8BsQ1Fe/qNAbfDO4fZUnsoq5Z55dcFDr37I=|dGIniQkSI7Xistm0KoJW8s6OfmGBS0OyfuBQCc3O52c=&quot;</span>
<span class=w>      </span><span class=p>},</span>
<span class=w>      </span><span class=nt>&quot;DeletedDate&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Edit&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Favorite&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Fields&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;FolderId&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Id&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;c8d320e9-c4c3-446c-8ede-f322edf0a980&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Identity&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Key&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Login&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nt>&quot;Password&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2.49gWnoaK1nI5Pn/pSIOYrg==|YpifIojSBpof3EbQ0GyNBA==|0WBUgT11Hwi6Hb8H4bks+ICsMFBH88QMIGyemLBFYog=&quot;</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Uri&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Username&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2.49gWnoaK1nI5Pn/pSIOYrg==|ZUZugs7e8BsQ1Fe/qNAbfDO4fZUnsoq5Z55dcFDr37I=|dGIniQkSI7Xistm0KoJW8s6OfmGBS0OyfuBQCc3O52c=&quot;</span>
<span class=w>      </span><span class=p>},</span>
<span class=w>      </span><span class=nt>&quot;Name&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2.49gWnoaK1nI5Pn/pSIOYrg==|5YpydD3KvqmmAej7fP/nkw==|+y1sS1Pi28xOPQT14k4UrYtc9TSJfgsf+nUjH3n/AAs=&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Notes&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Object&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;cipherDetails&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;OrganizationId&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;OrganizationUseTotp&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;PasswordHistory&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Reprompt&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;RevisionDate&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2024-06-17T20:30:24.341656Z&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;SecureNote&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Type&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;ViewPassword&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=p>{</span><span class=w> </span><span class=c1>// ... more ciphers }</span>
<span class=w>  </span><span class=p>]</span>
<span class=p>}</span>
</code></pre></div><p>Bitwarden has 4 types of entries: identities, cards, logins and notes. The above entry is a login entry, and the server sends duplicate information for the name, password and username. </p><p>But oops, I forgot to mention the <code>EncString</code> instantiation has to parse this format: <code>2.49gWnoaK1nI5Pn/pSIOYrg==|5YpydD3KvqmmAej7fP/nkw==|+y1sS1Pi28xOPQT14k4UrYtc9TSJfgsf+nUjH3n/AAs=</code>.</p><p>Indeed it is defined as <code>ALGO . IV_b64 | DATA_b64 | MAC_b64</code> (well, almost: <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/enc-string.ts#L111>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/enc-string.ts#L111</a> <a href=https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/enc-string.ts#L72>https://github.com/bitwarden/clients/blob/f0673dd16e1d5784c66b8fabae3121fb725ac028/libs/common/src/platform/models/domain/enc-string.ts#L72</a>) </p><p>That's it, I am a bit tired of trying to find my way around the code. </p><h2>Cryptanalysis</h2><p>I am no cryptographer but as far as I know cryptography implementation mistakes lie in the details. So, let's recap with not too much details. </p><ol><li>The client makes a request to the server (hopefully using https) </li><li>The server sends back a <code>KdfIteration</code> and <code>Kdf</code> field such that the client knows either to use PBKDF2 or Argon2id, and how many times it should iterate. The default configuration for my vault is <code>0</code> aka PBKDF2 and <code>600000</code> iterations, so we will keep that for the analysis. </li><li>The client prompts the user password and email, and derives them using the information from the previous step, computing <code>masterKey = PBKDF2(SHA256, password, email, 600000)</code> </li><li>Regardless of the previous <code>Kdf</code> , <code>serverMasterKeyHash</code> is computed as <code>PBKDF2(SHA256, masterKey, password, 1)</code> </li><li><code>serverMasterKeyHash</code> is sent to the server to authenticate </li><li>If authentication is successful, the server sends back an encrypted <code>Key</code> which is decrypted to get the decryption key <code>CipherKey</code>. First a stretched key and mac key are computed: <code>StretchedKey = HKDFExpandSHA256(masterKey, "enc")</code> and <code>MacKey = HKDFExpandSHA256(masterKey, "mac")</code>. Then the received key is decrypted: <code>CipherKey = AES256_CBC_Decrypt(StretchedKey, Key_iv, Key_data)</code></li><li>Ciphers (ie. names, notes, passwords, … - any string except dates) come with their encryption algorithm, IV, data and MAC data. The current default is AES256_CBC with HMAC_SHA256 but the codebase implements backwards compatibility with other schemes. </li><li>Ciphers are first checked with their MAC data as <code>cipher_mac == HMAC_SHA256(cipher_iv || cipher_data, MacKey)</code> </li><li>If successful, also decrypted as <code>clear = AES256_CBC_Decrypt(CipherKey, cipher_iv, cipher_data)</code> </li></ol><p>So the master password is derived 600,000 times which follows <a href=https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#pbkdf2>Owasp Password Storage cheatsheet</a> and Bitwarden uses standard encryption algorithms. We could argue that the usage of AES CBC with HMAC is a bit clumsy as one would rather use a more modern alternative like AES <a href=https://en.wikipedia.org/wiki/Galois/Counter_Mode>GCM</a>.</p><h2>Conclusion</h2><p>I consider the code of Bitwarden client to be of poor manufacture. I found it very hard to read, with too many layers of abstractions. To me, a software designed to securely store your most private things should be easy to read and easy to contribute to. In my opinion, finding where things where located in the code base was quite hard.</p><p>Here, the technical choice was to have an all-in-one application for the web and your desktop, which explains the usage of JavaScript (actually TypeScript, kudos!). Unfortunately I feel like although JavaScript is a super high-level language, the code was designed in a too hard to read fashion. </p><p>I started writing my own desktop client for the reasons I mentioned at the beginning of this article, using the <a href=https://www.qt.io/ >Qt</a> framework with C++. While it's not complete, you can check its implementation <a href=https://github.com/xarkes/bwd>here</a>. Is it easier to read? I hope so! Is it better? Not at all!</p></article><hr></main><footer> 2024 - Antide Petit aka <a href=/ >xarkes</a> - <a href=https://creativecommons.org/licenses/by-sa/4.0/ >CC-BY-SA</a> - Made with ❤️ </footer></body></html>